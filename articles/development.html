<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="geoarrow">
<title>C and C++ development guide • geoarrow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="C and C++ development guide">
<meta property="og:description" content="geoarrow">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">geoarrow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/geoarrow.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/development.html">C and C++ development guide</a>
    <a class="dropdown-item" href="../articles/format.html">Geometry storage formats in geoarrow</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="development_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>C and C++ development guide</h1>
            
      
      
      <div class="d-none name"><code>development.Rmd</code></div>
    </div>

    
    
<p>The geoarrow package exposes a <a href="geoarrow.html">set of high-level helpers to integrate geospatial data with Arrow Datasets</a> that depends on a low-level C++ to seamlessly and efficiently integrate with other representations of geometry in R and elsewhere. The <a href="format.html">format used</a> can be easily represented using the <a href="https://arrow.apache.org/docs/format/CDataInterface.html" class="external-link">Apache Arrow C Data interface</a>, exposing vectors of geometries as ABI-stable C structures that can be used without any header other than the two <code>struct</code> definitions in <a href="https://github.com/apache/arrow/blob/master/cpp/src/arrow/c/abi.h" class="external-link">arrow/c/abi.h</a>.</p>
<p>We’ll use the <a href="https://paleolimbot.github.io/narrow/" class="external-link">narrow</a> and geoarrow packages to demonstrate the structure of geoarrow arrays and how they can be iterated over in C and C++.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paleolimbot/narrow" class="external-link">narrow</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/geoarrow/">geoarrow</a></span><span class="op">)</span></code></pre></div>
<p>We’ll also need some test arrays with each of the six types supported in the Arrow-native format.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create.html">geoarrow_create</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"POINT (30 10)"</span>, <span class="st">"POINT (40 30)"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">linestrings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create.html">geoarrow_create</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
      <span class="st">"LINESTRING (30 10, 10 30, 40 40)"</span>, 
      <span class="st">"LINESTRING (0 0, 10 5)"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">polygons</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create.html">geoarrow_create</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
      <span class="st">"POLYGON ((30 10, 40 40, 20 40, 10 20, 30 10))"</span>, 
      <span class="st">"POLYGON (
        (35 10, 45 45, 15 40, 10 20, 35 10),
        (20 30, 35 35, 30 20, 20 30))"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">multipoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create.html">geoarrow_create</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MULTIPOINT (0 1, 2 3)"</span>, <span class="st">"MULTIPOINT (0 0, 3 8)"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">multilinestrings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create.html">geoarrow_create</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
      <span class="st">"MULTILINESTRING ((30 10, 40 40, 20 40, 10 20, 30 10))"</span>, 
      <span class="st">"MULTILINESTRING (
        (35 10, 45 45, 15 40, 10 20, 35 10),
        (20 30, 35 35, 30 20, 20 30))"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">multipolygons</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create.html">geoarrow_create</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
      <span class="st">"MULTIPOLYGON (
        ((30 20, 45 40, 10 40, 30 20)),
        ((15 5, 40 10, 10 20, 5 10, 15 5)))"</span>, 
      <span class="st">"MULTIPOLYGON (
        ((40 40, 20 45, 45 30, 40 40)),
        ((20 35, 10 30, 10 10, 30 5, 45 20, 20 35),
          (30 20, 20 15, 20 25, 30 20)))"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p><img src="development_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>The other piece of setup you may need to follow along is a way to pass the example arrays into C and/or C++ code. If you are writing an R package, you can include the narrow package in your <code>LinkingTo:</code> field in your DESCRIPTION; if you are writing an RMarkdown document (like this one), you can set your PKG_CPPFLAGS environment variable to include the “include” directory in the narrow package directory:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>
  PKG_CPPFLAGS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"-I"</span>, <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"include"</span>, package <span class="op">=</span> <span class="st">"narrow"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>This will let you <code>#include "narrow.h"</code>, which includes a copy of the Arrow C Data structure definitions and functions to extract them safely from R objects.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span></code></pre></div>
<div class="section level2">
<h2 id="inspecting-the-data-from-r">Inspecting the data from R<a class="anchor" aria-label="anchor" href="#inspecting-the-data-from-r"></a>
</h2>
<p>The easiest way to inspect geoarrow array data is from R using the <a href="https://paleolimbot.github.io/wk/" class="external-link">wk</a> package. The general structure of an array is available from <code><a href="https://paleolimbot.github.io/wk/reference/wk_meta.html" class="external-link">wk::wk_vector_meta()</a></code>, which is fast (it doesn’t iterate over all the points).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_meta.html" class="external-link">wk_vector_meta</a></span><span class="op">(</span><span class="va">points</span><span class="op">)</span>
<span class="co">#&gt;   geometry_type size has_z has_m</span>
<span class="co">#&gt; 1             1    2 FALSE FALSE</span></code></pre></div>
<p>If you need the geodesic flag or the CRS, you can use <code>wk::wk_is_geoesic()</code> or <code><a href="https://paleolimbot.github.io/wk/reference/wk_crs.html" class="external-link">wk::wk_crs()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_is_geodesic.html" class="external-link">wk_is_geodesic</a></span><span class="op">(</span><span class="va">points</span><span class="op">)</span>
<span class="co">#&gt; [1] FALSE</span>
<span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_crs.html" class="external-link">wk_crs</a></span><span class="op">(</span><span class="va">points</span><span class="op">)</span>
<span class="co">#&gt; NULL</span></code></pre></div>
<p>You can access coordinate values as flat arrays using <code>wk_coords()</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_vertices.html" class="external-link">wk_coords</a></span><span class="op">(</span><span class="va">linestrings</span><span class="op">)</span>
<span class="co">#&gt;   feature_id part_id ring_id  x  y</span>
<span class="co">#&gt; 1          1       1       0 30 10</span>
<span class="co">#&gt; 2          1       1       0 10 30</span>
<span class="co">#&gt; 3          1       1       0 40 40</span>
<span class="co">#&gt; 4          2       2       0  0  0</span>
<span class="co">#&gt; 5          2       2       0 10  5</span></code></pre></div>
<p>If you need geoarrow/arrow-specific metadata information, you can inspect the schemas directly using the list-like interface of schem aobjects. The most important thing you will have to check is the extension name, which will tell you which bit of compiled code you will need to safely access the array data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">metadata</span><span class="op">[[</span><span class="st">"ARROW:extension:name"</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; [1] "geoarrow.point"</span></code></pre></div>
<p>For points, you will also have to check dimensions and the storage type, since depending on the dimensions and/or encoding the underlying arrays could have buffer numbers and/or types.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span>
<span class="co">#&gt; [1] "+w:2"</span>
<span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span>
<span class="co">#&gt; [1] "g"</span>
<span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">name</span>
<span class="co">#&gt; [1] "xy"</span></code></pre></div>
<p>The above output indicates that the point array is a fixed-size list (size 2) whose child is a float64. The dimension output indicates that the dimension type is xy.</p>
<p>You may also need to access the extension metadata which contains information like the CRS. This metadata is serialized in the raw schema, so you’ll need <code><a href="../reference/geoarrow_metadata.html">geoarrow_metadata()</a></code> to extract it.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/geoarrow_metadata.html">geoarrow_metadata</a></span><span class="op">(</span><span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span>
<span class="co">#&gt; named list()</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="inspecting-the-data-using-geoarrow-hpp">Inspecting the data using geoarrow.hpp<a class="anchor" aria-label="anchor" href="#inspecting-the-data-using-geoarrow-hpp"></a>
</h2>
<p>(TODO…write this!)</p>
</div>
<div class="section level2">
<h2 id="inspecting-the-data-from-c">Inspecting the data from C<a class="anchor" aria-label="anchor" href="#inspecting-the-data-from-c"></a>
</h2>
<p>If you need to deal with arbitrary vectors of that may have different types or different point encodings, you should <code>#include "geoarrow.hpp"</code> and use the helper functions provided there; however, the geoarrow format was designed to be accessible from C code without helpers. If you can make some assumptions about the geometry type and storage type of your input but still want the speed of compiled code, using the C structures directly may be a good fit.</p>
<p>The easiest way to inspect the schema, which encodes the storage type and extra geo-specific extension metadata, is to do it before you drop into C. In particular, <code><a href="https://paleolimbot.github.io/wk/reference/wk_meta.html" class="external-link">wk::wk_vector_meta()</a></code> has been implemented for geoarrow arrays in such a way that it will (1) validate the schema to let you make stronger assumptions about the C structures you are given and (2) deserialize and extract the metadata you might need to reduce the number of problems you have to solve in C.</p>
<p>If you really do need to do this in compiled code, you can access the <code>struct ArrowSchema</code> directly. For example, to extract the dimensions from C, you can do this:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a>SEXP c_point_dimensions(SEXP schema_xptr) {</span>
<span id="cb11-5"><a href="#cb11-5"></a>  <span class="kw">struct</span> ArrowSchema* schema = schema_from_xptr(schema_xptr, <span class="st">"schema"</span>);</span>
<span id="cb11-6"><a href="#cb11-6"></a>  <span class="cf">return</span> Rf_mkString(schema-&gt;children[<span class="dv">0</span>]-&gt;name);</span>
<span id="cb11-7"><a href="#cb11-7"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_point_dimensions"</span>, <span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span>
<span class="co">#&gt; [1] "xy"</span>
<span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_point_dimensions"</span>, <span class="va">linestrings</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; [1] "xy"</span></code></pre></div>
<p>If you’re in R, the preferred approach is to extract the information you need from <code><a href="https://paleolimbot.github.io/wk/reference/wk_meta.html" class="external-link">wk::wk_vector_meta()</a></code>, since this will also validate the schema (making it so that you can write more compact compiled code that assumes a valid structure).</p>
<p>Now that we’ve inspected the metadata, we can move on to the data! Accessing the coordinates and doing things with them is the whole reason we’re all here…so let’s get to it! As an example, I’m going to print coordinates with information about the containing structures.</p>
<div class="section level3">
<h3 id="points">Points<a class="anchor" aria-label="anchor" href="#points"></a>
</h3>
<p>For points encoded as a fixed-size list (the default), you need three pieces of information: the length, the initial offset into the array, and the buffer of <code>double</code>s containing the coordinates. You will need to validate at least this much about the schema in advance:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span>
  <span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+w:2"</span>,
  <span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"g"</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a>SEXP c_point_print(SEXP array_data_xptr) {</span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="kw">struct</span> ArrowArray* array_data = array_data_from_xptr(array_data_xptr, <span class="st">"array_data"</span>);</span>
<span id="cb14-6"><a href="#cb14-6"></a>  </span>
<span id="cb14-7"><a href="#cb14-7"></a>  <span class="dt">int</span> coord_size = <span class="dv">2</span>;</span>
<span id="cb14-8"><a href="#cb14-8"></a>  <span class="dt">double</span>* coords = (<span class="dt">double</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb14-9"><a href="#cb14-9"></a>  coords = coords + (array_data-&gt;offset) * coord_size;</span>
<span id="cb14-10"><a href="#cb14-10"></a></span>
<span id="cb14-11"><a href="#cb14-11"></a>  <span class="dt">double</span>* coord;</span>
<span id="cb14-12"><a href="#cb14-12"></a>  <span class="cf">for</span> (<span class="dt">int64_t</span> i = <span class="dv">0</span>; i &lt; array_data-&gt;length; i++) {</span>
<span id="cb14-13"><a href="#cb14-13"></a>    coord = coords + (i * coord_size);</span>
<span id="cb14-14"><a href="#cb14-14"></a>    Rprintf(<span class="st">"point[%d] (%g %g)</span><span class="sc">\n</span><span class="st">"</span>, i, coord[<span class="dv">0</span>], coord[<span class="dv">1</span>]);</span>
<span id="cb14-15"><a href="#cb14-15"></a>  }</span>
<span id="cb14-16"><a href="#cb14-16"></a>  </span>
<span id="cb14-17"><a href="#cb14-17"></a>  <span class="cf">return</span> R_NilValue;</span>
<span id="cb14-18"><a href="#cb14-18"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_point_print"</span>, <span class="va">points</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; point[0] (30 10)</span>
<span class="co">#&gt; point[1] (40 30)</span></code></pre></div>
<p>For points encoded as a struct, the approach is similar but one buffer per dimension is required. You will need to validate at least this much in advance:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">points_struct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create.html">geoarrow_create</a></span><span class="op">(</span>
  <span class="va">points</span>,
  schema <span class="op">=</span> <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_point_struct</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span>
  <span class="va">points_struct</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+s"</span>,
  <span class="va">points_struct</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"g"</span>,
  <span class="va">points_struct</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"g"</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a>SEXP c_point_struct_print(SEXP array_data_xptr) {</span>
<span id="cb17-5"><a href="#cb17-5"></a>  <span class="kw">struct</span> ArrowArray* array_data = array_data_from_xptr(array_data_xptr, <span class="st">"array_data"</span>);</span>
<span id="cb17-6"><a href="#cb17-6"></a>  </span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="dt">double</span>* x = (<span class="dt">double</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb17-8"><a href="#cb17-8"></a>  <span class="dt">double</span>* y = (<span class="dt">double</span>*) array_data-&gt;children[<span class="dv">1</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb17-9"><a href="#cb17-9"></a>  x = x + array_data-&gt;offset;</span>
<span id="cb17-10"><a href="#cb17-10"></a>  y = y + array_data-&gt;offset;</span>
<span id="cb17-11"><a href="#cb17-11"></a></span>
<span id="cb17-12"><a href="#cb17-12"></a>  <span class="cf">for</span> (<span class="dt">int64_t</span> i = <span class="dv">0</span>; i &lt; array_data-&gt;length; i++) {</span>
<span id="cb17-13"><a href="#cb17-13"></a>    Rprintf(<span class="st">"point[%d] (%g %g)</span><span class="sc">\n</span><span class="st">"</span>, i, x[i], y[i]);</span>
<span id="cb17-14"><a href="#cb17-14"></a>  }</span>
<span id="cb17-15"><a href="#cb17-15"></a>  </span>
<span id="cb17-16"><a href="#cb17-16"></a>  <span class="cf">return</span> R_NilValue;</span>
<span id="cb17-17"><a href="#cb17-17"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_point_struct_print"</span>, <span class="va">points_struct</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; point[0] (30 10)</span>
<span class="co">#&gt; point[1] (40 30)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="linestrings">Linestrings<a class="anchor" aria-label="anchor" href="#linestrings"></a>
</h3>
<p>In addition to all the information about a point, you also need the offsets into the point array from the outer linestring. Just like the point, you’ll need to validate a few things about the array that you have been handed to avoid a segfault.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span>
  <span class="va">linestrings</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
  <span class="va">linestrings</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+w:2"</span>,
  <span class="va">linestrings</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"g"</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb20-3"><a href="#cb20-3"></a></span>
<span id="cb20-4"><a href="#cb20-4"></a>SEXP c_linestring_print(SEXP array_data_xptr) {</span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="kw">struct</span> ArrowArray* array_data = array_data_from_xptr(array_data_xptr, <span class="st">"array_data"</span>);</span>
<span id="cb20-6"><a href="#cb20-6"></a>  </span>
<span id="cb20-7"><a href="#cb20-7"></a>  <span class="dt">int</span> coord_size = <span class="dv">2</span>;</span>
<span id="cb20-8"><a href="#cb20-8"></a>  <span class="dt">double</span>* coords = (<span class="dt">double</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb20-9"><a href="#cb20-9"></a>  <span class="dt">int32_t</span>* coord_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb20-10"><a href="#cb20-10"></a>  </span>
<span id="cb20-11"><a href="#cb20-11"></a>  coord_offsets = coord_offsets + array_data-&gt;offset;</span>
<span id="cb20-12"><a href="#cb20-12"></a>  coords = coords + coord_offsets[<span class="dv">0</span>];</span>
<span id="cb20-13"><a href="#cb20-13"></a></span>
<span id="cb20-14"><a href="#cb20-14"></a>  <span class="dt">double</span>* coord;</span>
<span id="cb20-15"><a href="#cb20-15"></a>  <span class="cf">for</span> (<span class="dt">int64_t</span> i = <span class="dv">0</span>; i &lt; array_data-&gt;length; i++) {</span>
<span id="cb20-16"><a href="#cb20-16"></a>    <span class="dt">int32_t</span> n_coords = coord_offsets[i + <span class="dv">1</span>] - coord_offsets[i];</span>
<span id="cb20-17"><a href="#cb20-17"></a>    </span>
<span id="cb20-18"><a href="#cb20-18"></a>    <span class="cf">for</span> (<span class="dt">int32_t</span> j = <span class="dv">0</span>; j &lt; n_coords; j++) {</span>
<span id="cb20-19"><a href="#cb20-19"></a>      coord = coords + coord_size * (coord_offsets[i] + j);</span>
<span id="cb20-20"><a href="#cb20-20"></a>      Rprintf(<span class="st">"linestring[%d]-&gt;point[%d] (%g %g)</span><span class="sc">\n</span><span class="st">"</span>, i, j, coord[<span class="dv">0</span>], coord[<span class="dv">1</span>]);</span>
<span id="cb20-21"><a href="#cb20-21"></a>    }</span>
<span id="cb20-22"><a href="#cb20-22"></a>  }</span>
<span id="cb20-23"><a href="#cb20-23"></a>  </span>
<span id="cb20-24"><a href="#cb20-24"></a>  <span class="cf">return</span> R_NilValue;</span>
<span id="cb20-25"><a href="#cb20-25"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_linestring_print"</span>, <span class="va">linestrings</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; linestring[0]-&gt;point[0] (30 10)</span>
<span class="co">#&gt; linestring[0]-&gt;point[1] (10 30)</span>
<span class="co">#&gt; linestring[0]-&gt;point[2] (40 40)</span>
<span class="co">#&gt; linestring[1]-&gt;point[0] (0 0)</span>
<span class="co">#&gt; linestring[1]-&gt;point[1] (10 5)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="polygons">Polygons<a class="anchor" aria-label="anchor" href="#polygons"></a>
</h3>
<p>In addition to all the information about a linestring, you also need the offsets into the rings array from the outer polygon You’ll need to validate the outer layer in addition to all the bits validated about the inner arrays.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span>
  <span class="va">polygons</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
  <span class="va">polygons</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
  <span class="va">polygons</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+w:2"</span>,
  <span class="va">polygons</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"g"</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb23-1"><a href="#cb23-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb23-3"><a href="#cb23-3"></a></span>
<span id="cb23-4"><a href="#cb23-4"></a>SEXP c_polygon_print(SEXP array_data_xptr) {</span>
<span id="cb23-5"><a href="#cb23-5"></a>  <span class="kw">struct</span> ArrowArray* array_data = array_data_from_xptr(array_data_xptr, <span class="st">"array_data"</span>);</span>
<span id="cb23-6"><a href="#cb23-6"></a>  </span>
<span id="cb23-7"><a href="#cb23-7"></a>  <span class="dt">int</span> coord_size = <span class="dv">2</span>;</span>
<span id="cb23-8"><a href="#cb23-8"></a>  <span class="dt">double</span>* coords = (<span class="dt">double</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb23-9"><a href="#cb23-9"></a>  <span class="dt">int32_t</span>* coord_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb23-10"><a href="#cb23-10"></a>  <span class="dt">int32_t</span>* ring_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb23-11"><a href="#cb23-11"></a>  </span>
<span id="cb23-12"><a href="#cb23-12"></a>  ring_offsets = ring_offsets + array_data-&gt;offset;</span>
<span id="cb23-13"><a href="#cb23-13"></a>  coord_offsets = coord_offsets + ring_offsets[<span class="dv">0</span>];</span>
<span id="cb23-14"><a href="#cb23-14"></a>  coords = coords + coord_offsets[<span class="dv">0</span>];</span>
<span id="cb23-15"><a href="#cb23-15"></a></span>
<span id="cb23-16"><a href="#cb23-16"></a>  <span class="dt">double</span>* coord;</span>
<span id="cb23-17"><a href="#cb23-17"></a>  <span class="dt">int32_t</span>* coord_offset;</span>
<span id="cb23-18"><a href="#cb23-18"></a>  <span class="cf">for</span> (<span class="dt">int64_t</span> i = <span class="dv">0</span>; i &lt; array_data-&gt;length; i++) {</span>
<span id="cb23-19"><a href="#cb23-19"></a>    <span class="dt">int32_t</span> n_seq = ring_offsets[i + <span class="dv">1</span>] - ring_offsets[i];</span>
<span id="cb23-20"><a href="#cb23-20"></a>    coord_offset = coord_offsets + ring_offsets[i];</span>
<span id="cb23-21"><a href="#cb23-21"></a>    </span>
<span id="cb23-22"><a href="#cb23-22"></a>    </span>
<span id="cb23-23"><a href="#cb23-23"></a>    <span class="cf">for</span> (<span class="dt">int32_t</span> j = <span class="dv">0</span>; j &lt; n_seq; j++) {</span>
<span id="cb23-24"><a href="#cb23-24"></a>      <span class="dt">int32_t</span> n_coords = coord_offset[j + <span class="dv">1</span>] - coord_offset[j];</span>
<span id="cb23-25"><a href="#cb23-25"></a>      </span>
<span id="cb23-26"><a href="#cb23-26"></a>      <span class="cf">for</span> (<span class="dt">int32_t</span> k = <span class="dv">0</span>; k &lt; n_coords; k++) {</span>
<span id="cb23-27"><a href="#cb23-27"></a>        coord = coords + (coord_size * (coord_offset[j] + k));</span>
<span id="cb23-28"><a href="#cb23-28"></a>        Rprintf(</span>
<span id="cb23-29"><a href="#cb23-29"></a>          <span class="st">"polygon[%d]-&gt;ring[%d]-&gt;point[%d] (%g %g)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb23-30"><a href="#cb23-30"></a>          i, j, k, coord[<span class="dv">0</span>], coord[<span class="dv">1</span>]);</span>
<span id="cb23-31"><a href="#cb23-31"></a>      }</span>
<span id="cb23-32"><a href="#cb23-32"></a>    }</span>
<span id="cb23-33"><a href="#cb23-33"></a>  }</span>
<span id="cb23-34"><a href="#cb23-34"></a>  </span>
<span id="cb23-35"><a href="#cb23-35"></a>  <span class="cf">return</span> R_NilValue;</span>
<span id="cb23-36"><a href="#cb23-36"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_polygon_print"</span>, <span class="va">polygons</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[0] (30 10)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[1] (40 40)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[2] (20 40)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[3] (10 20)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[4] (30 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[0] (35 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[1] (45 45)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[2] (15 40)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[3] (10 20)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[4] (35 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[0] (20 30)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[1] (35 35)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[2] (30 20)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[3] (20 30)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multipoints">Multipoints<a class="anchor" aria-label="anchor" href="#multipoints"></a>
</h3>
<p>Iterating over multipoints requires the same code and assertions as for linestrings:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_linestring_print"</span>, <span class="va">multipoints</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; linestring[0]-&gt;point[0] (0 1)</span>
<span class="co">#&gt; linestring[0]-&gt;point[1] (2 3)</span>
<span class="co">#&gt; linestring[1]-&gt;point[0] (0 0)</span>
<span class="co">#&gt; linestring[1]-&gt;point[1] (3 8)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multilinestrings">Multilinestrings<a class="anchor" aria-label="anchor" href="#multilinestrings"></a>
</h3>
<p>Iterating over multilinestrings requires the same code and assertions as for polygons:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_polygon_print"</span>, <span class="va">multilinestrings</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[0] (30 10)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[1] (40 40)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[2] (20 40)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[3] (10 20)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[4] (30 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[0] (35 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[1] (45 45)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[2] (15 40)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[3] (10 20)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[4] (35 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[0] (20 30)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[1] (35 35)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[2] (30 20)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[3] (20 30)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multipolygons">Multipolygons<a class="anchor" aria-label="anchor" href="#multipolygons"></a>
</h3>
<p>In addition to all the information about a polygon, you also need the offsets into the geometries array from the outer collection. You’ll need to validate the outer layer in addition to all the bits validated about the inner arrays.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span>
  <span class="va">multipolygons</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
  <span class="va">multipolygons</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
  <span class="va">multipolygons</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
  <span class="va">multipolygons</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+w:2"</span>,
  <span class="va">multipolygons</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"g"</span>
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb28-1"><a href="#cb28-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb28-3"><a href="#cb28-3"></a></span>
<span id="cb28-4"><a href="#cb28-4"></a>SEXP c_multipolygon_print(SEXP array_data_xptr) {</span>
<span id="cb28-5"><a href="#cb28-5"></a>  <span class="kw">struct</span> ArrowArray* array_data = array_data_from_xptr(array_data_xptr, <span class="st">"array_data"</span>);</span>
<span id="cb28-6"><a href="#cb28-6"></a>  </span>
<span id="cb28-7"><a href="#cb28-7"></a>  <span class="dt">int</span> coord_size = <span class="dv">2</span>;</span>
<span id="cb28-8"><a href="#cb28-8"></a>  <span class="dt">double</span>* coords = (<span class="dt">double</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb28-9"><a href="#cb28-9"></a>  <span class="dt">int32_t</span>* coord_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb28-10"><a href="#cb28-10"></a>  <span class="dt">int32_t</span>* ring_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb28-11"><a href="#cb28-11"></a>  <span class="dt">int32_t</span>* geom_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb28-12"><a href="#cb28-12"></a>  </span>
<span id="cb28-13"><a href="#cb28-13"></a>  geom_offsets = geom_offsets + array_data-&gt;offset;</span>
<span id="cb28-14"><a href="#cb28-14"></a>  ring_offsets = ring_offsets + geom_offsets[<span class="dv">0</span>];</span>
<span id="cb28-15"><a href="#cb28-15"></a>  coord_offsets = coord_offsets + ring_offsets[<span class="dv">0</span>];</span>
<span id="cb28-16"><a href="#cb28-16"></a>  coords = coords + coord_offsets[<span class="dv">0</span>];</span>
<span id="cb28-17"><a href="#cb28-17"></a></span>
<span id="cb28-18"><a href="#cb28-18"></a>  <span class="dt">double</span>* coord;</span>
<span id="cb28-19"><a href="#cb28-19"></a>  <span class="dt">int32_t</span>* coord_offset;</span>
<span id="cb28-20"><a href="#cb28-20"></a>  <span class="dt">int32_t</span>* ring_offset;</span>
<span id="cb28-21"><a href="#cb28-21"></a>  <span class="cf">for</span> (<span class="dt">int64_t</span> i = <span class="dv">0</span>; i &lt; array_data-&gt;length; i++) {</span>
<span id="cb28-22"><a href="#cb28-22"></a>    <span class="dt">int32_t</span> n_geoms = geom_offsets[i + <span class="dv">1</span>] - geom_offsets[i];</span>
<span id="cb28-23"><a href="#cb28-23"></a>    ring_offset = ring_offsets + geom_offsets[i];</span>
<span id="cb28-24"><a href="#cb28-24"></a>    </span>
<span id="cb28-25"><a href="#cb28-25"></a>    <span class="cf">for</span> (<span class="dt">int32_t</span> j = <span class="dv">0</span>; j &lt; n_geoms; j++) {</span>
<span id="cb28-26"><a href="#cb28-26"></a>      <span class="dt">int32_t</span> n_rings = ring_offset[j + <span class="dv">1</span>] - ring_offset[j];</span>
<span id="cb28-27"><a href="#cb28-27"></a>      coord_offset = coord_offsets + ring_offsets[j];</span>
<span id="cb28-28"><a href="#cb28-28"></a>      </span>
<span id="cb28-29"><a href="#cb28-29"></a>      </span>
<span id="cb28-30"><a href="#cb28-30"></a>      <span class="cf">for</span> (<span class="dt">int32_t</span> k = <span class="dv">0</span>; k &lt; n_rings; k++) {</span>
<span id="cb28-31"><a href="#cb28-31"></a>        <span class="dt">int32_t</span> n_coords = coord_offset[k + <span class="dv">1</span>] - coord_offset[k];</span>
<span id="cb28-32"><a href="#cb28-32"></a>        </span>
<span id="cb28-33"><a href="#cb28-33"></a>        <span class="cf">for</span> (<span class="dt">int32_t</span> l = <span class="dv">0</span>; l &lt; n_coords; l++) {</span>
<span id="cb28-34"><a href="#cb28-34"></a>          coord = coords + (coord_size * (coord_offset[k] + l));</span>
<span id="cb28-35"><a href="#cb28-35"></a>          Rprintf(</span>
<span id="cb28-36"><a href="#cb28-36"></a>            <span class="st">"multipolygon[%d]-&gt;polygon[%d]-&gt;ring[%d]-&gt;point[%d] (%g %g)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb28-37"><a href="#cb28-37"></a>            i, j, k, l, coord[<span class="dv">0</span>], coord[<span class="dv">1</span>]);</span>
<span id="cb28-38"><a href="#cb28-38"></a>        }</span>
<span id="cb28-39"><a href="#cb28-39"></a>      }</span>
<span id="cb28-40"><a href="#cb28-40"></a>    } </span>
<span id="cb28-41"><a href="#cb28-41"></a>  }</span>
<span id="cb28-42"><a href="#cb28-42"></a>  </span>
<span id="cb28-43"><a href="#cb28-43"></a>  <span class="cf">return</span> R_NilValue;</span>
<span id="cb28-44"><a href="#cb28-44"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_multipolygon_print"</span>, <span class="va">multipolygons</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[0]-&gt;ring[0]-&gt;point[0] (30 20)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[0]-&gt;ring[0]-&gt;point[1] (45 40)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[0]-&gt;ring[0]-&gt;point[2] (10 40)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[0]-&gt;ring[0]-&gt;point[3] (30 20)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[1]-&gt;ring[0]-&gt;point[0] (15 5)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[1]-&gt;ring[0]-&gt;point[1] (40 10)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[1]-&gt;ring[0]-&gt;point[2] (10 20)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[1]-&gt;ring[0]-&gt;point[3] (5 10)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[1]-&gt;ring[0]-&gt;point[4] (15 5)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[0]-&gt;ring[0]-&gt;point[0] (30 20)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[0]-&gt;ring[0]-&gt;point[1] (45 40)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[0]-&gt;ring[0]-&gt;point[2] (10 40)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[0]-&gt;ring[0]-&gt;point[3] (30 20)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[0]-&gt;point[0] (15 5)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[0]-&gt;point[1] (40 10)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[0]-&gt;point[2] (10 20)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[0]-&gt;point[3] (5 10)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[0]-&gt;point[4] (15 5)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[1]-&gt;point[0] (40 40)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[1]-&gt;point[1] (20 45)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[1]-&gt;point[2] (45 30)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[1]-&gt;point[3] (40 40)</span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Dewey Dunnington.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>

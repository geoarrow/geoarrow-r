<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="geoarrow">
<title>C and C++ development guide • geoarrow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="C and C++ development guide">
<meta property="og:description" content="geoarrow">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">geoarrow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/geoarrow.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/development.html">C and C++ development guide</a>
    <a class="dropdown-item" href="../articles/format.html">Geometry storage formats in geoarrow</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="development_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>C and C++ development guide</h1>
            
      
      
      <div class="d-none name"><code>development.Rmd</code></div>
    </div>

    
    
<p>The geoarrow package exposes a <a href="geoarrow.html">set of high-level helpers to integrate geospatial data with Arrow Datasets</a>; however, the <a href="format.html">format used</a> can be easily represented using the <a href="https://arrow.apache.org/docs/format/CDataInterface.html" class="external-link">Apache Arrow C Data interface</a>, exposing vectors of geometries as ABI-stable C structures that can be used without any header other than the two <code>struct</code> definitions in <a href="https://github.com/apache/arrow/blob/master/cpp/src/arrow/c/abi.h" class="external-link">arrow/c/abi.h</a>.</p>
<p>We’ll use the <a href="https://paleolimbot.github.io/narrow/" class="external-link">narrow</a> and geoarrow packages to demonstrate the structure of geoarrow arrays and how they can be iterated over in C and C++.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paleolimbot/narrow" class="external-link">narrow</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/geoarrow/">geoarrow</a></span><span class="op">)</span></code></pre></div>
<p>We’ll also need some test arrays with each of the six types supported in the Arrow-native format.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"POINT (30 10)"</span>, <span class="st">"POINT (40 30)"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">linestrings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
      <span class="st">"LINESTRING (30 10, 10 30, 40 40)"</span>,
      <span class="st">"LINESTRING (0 0, 10 5)"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">polygons</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
      <span class="st">"POLYGON ((30 10, 40 40, 20 40, 10 20, 30 10))"</span>,
      <span class="st">"POLYGON (
        (35 10, 45 45, 15 40, 10 20, 35 10),
        (20 30, 35 35, 30 20, 20 30))"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">multipoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MULTIPOINT (0 1, 2 3)"</span>, <span class="st">"MULTIPOINT (0 0, 3 8)"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">multilinestrings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
      <span class="st">"MULTILINESTRING ((30 10, 40 40, 20 40, 10 20, 30 10))"</span>,
      <span class="st">"MULTILINESTRING (
        (35 10, 45 45, 15 40, 10 20, 35 10),
        (20 30, 35 35, 30 20, 20 30))"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">multipolygons</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
      <span class="st">"MULTIPOLYGON (
        ((30 20, 45 40, 10 40, 30 20)),
        ((15 5, 40 10, 10 20, 5 10, 15 5)))"</span>,
      <span class="st">"MULTIPOLYGON (
        ((40 40, 20 45, 45 30, 40 40)),
        ((20 35, 10 30, 10 10, 30 5, 45 20, 20 35),
          (30 20, 20 15, 20 25, 30 20)))"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p><img src="development_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>The other piece of setup you may need to follow along is a way to pass the example arrays into C and/or C++ code. If you are writing an R package, you can include the narrow package in your <code>LinkingTo:</code> field in your DESCRIPTION; if you are writing an RMarkdown document (like this one), you can set your PKG_CPPFLAGS environment variable to include the “include” directory in the narrow package directory:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>
  PKG_CPPFLAGS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"-I"</span>, <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"include"</span>, package <span class="op">=</span> <span class="st">"narrow"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>This will let you <code>#include "narrow.h"</code>, which includes a copy of the Arrow C Data structure definitions and functions to extract them safely from R objects.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span></code></pre></div>
<div class="section level2">
<h2 id="reading-geoarrow-arrays-in-r">Reading geoarrow arrays in R<a class="anchor" aria-label="anchor" href="#reading-geoarrow-arrays-in-r"></a>
</h2>
<p>The easiest way to inspect geoarrow array data is from R using the <a href="https://paleolimbot.github.io/wk/" class="external-link">wk</a> package. The general structure of an array is available from <code><a href="https://paleolimbot.github.io/wk/reference/wk_meta.html" class="external-link">wk::wk_vector_meta()</a></code>, which is fast (it doesn’t iterate over all the points).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_meta.html" class="external-link">wk_vector_meta</a></span><span class="op">(</span><span class="va">points</span><span class="op">)</span>
<span class="co">#&gt;   geometry_type size has_z has_m</span>
<span class="co">#&gt; 1             1    2 FALSE FALSE</span></code></pre></div>
<p>If you need the geodesic flag or the CRS, you can use <code>wk::wk_is_geoesic()</code> or <code><a href="https://paleolimbot.github.io/wk/reference/wk_crs.html" class="external-link">wk::wk_crs()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_is_geodesic.html" class="external-link">wk_is_geodesic</a></span><span class="op">(</span><span class="va">points</span><span class="op">)</span>
<span class="co">#&gt; [1] FALSE</span>
<span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_crs.html" class="external-link">wk_crs</a></span><span class="op">(</span><span class="va">points</span><span class="op">)</span>
<span class="co">#&gt; NULL</span></code></pre></div>
<p>You can access coordinate values as flat arrays using <code>wk_coords()</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_vertices.html" class="external-link">wk_coords</a></span><span class="op">(</span><span class="va">linestrings</span><span class="op">)</span>
<span class="co">#&gt;   feature_id part_id ring_id  x  y</span>
<span class="co">#&gt; 1          1       1       0 30 10</span>
<span class="co">#&gt; 2          1       1       0 10 30</span>
<span class="co">#&gt; 3          1       1       0 40 40</span>
<span class="co">#&gt; 4          2       2       0  0  0</span>
<span class="co">#&gt; 5          2       2       0 10  5</span></code></pre></div>
<p>The geoarrow package implements <code><a href="https://paleolimbot.github.io/wk/reference/wk_handle.html" class="external-link">wk::wk_handle()</a></code>, so you can use any handler or filter defined in any package. For example, you can apply an affine transform and create a <code><a href="https://paleolimbot.github.io/wk/reference/wkb.html" class="external-link">wk::wkb()</a></code> vector in one step (with zero intermediary copies):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_handle.html" class="external-link">wk_handle</a></span><span class="op">(</span>
  <span class="va">linestrings</span>,
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_transform.html" class="external-link">wk_transform_filter</a></span><span class="op">(</span>
    trans <span class="op">=</span> <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_trans_affine.html" class="external-link">wk_affine_rotate</a></span><span class="op">(</span><span class="fl">90</span><span class="op">)</span>,
    handler <span class="op">=</span> <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wk_writer.html" class="external-link">wkb_writer</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; &lt;wk_wkb[2]&gt;</span>
<span class="co">#&gt; [1] &lt;LINESTRING (-10 30, -30 10, -40 40)&gt; &lt;LINESTRING (0 0, -5 10)&gt;</span></code></pre></div>
<p>You can use the <code><a href="https://paleolimbot.github.io/wk/reference/wk_writer.html" class="external-link">wk::sfc_writer()</a></code> handler to generate sf objects. Note that when using the <code><a href="https://paleolimbot.github.io/wk/reference/wk_handle.html" class="external-link">wk::wk_handle()</a></code> interface, you will have to propagate the CRS and/or geodesic flags yourself. For a guide on how to write filters and handlers in C and C++, see the <a href="https://paleolimbot.github.io/wk/articles/programming.html" class="external-link">programming vignette</a> from the wk package.</p>
<p>If you need geoarrow/arrow-specific metadata information, you can inspect the schemas directly using the list-like interface of schem aobjects. The most important thing you will have to check is the extension name, which will tell you which bit of compiled code you will need to safely access the array data.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">metadata</span><span class="op">[[</span><span class="st">"ARROW:extension:name"</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; [1] "geoarrow.point"</span></code></pre></div>
<p>For points, you will also have to check dimensions and the storage type, since depending on the dimensions and/or encoding the underlying arrays could have buffer numbers and/or types.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span>
<span class="co">#&gt; [1] "+w:2"</span>
<span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span>
<span class="co">#&gt; [1] "g"</span>
<span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">name</span>
<span class="co">#&gt; [1] "xy"</span></code></pre></div>
<p>The above output indicates that the point array is a fixed-size list (size 2) whose child is a float64. The dimension output indicates that the dimension type is xy.</p>
<p>You may also need to access the extension metadata which contains information like the CRS. This metadata is serialized in the raw schema, so you’ll need <code><a href="../reference/geoarrow_metadata.html">geoarrow_metadata()</a></code> to extract it.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/geoarrow_metadata.html">geoarrow_metadata</a></span><span class="op">(</span><span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span>
<span class="co">#&gt; named list()</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="reading-geoarrow-arrays-using-geoarrow-hpp">Reading geoarrow arrays using geoarrow.hpp<a class="anchor" aria-label="anchor" href="#reading-geoarrow-arrays-using-geoarrow-hpp"></a>
</h2>
<p>Built-in operations in the geoarrow package use the geoarrow.hpp helper file, which defines a few classes and functions to ease dealing with multiple extension types, dimensions, and point storage types. This is currently an evolving library; however, you can copy the file and include it in another R package or project (it requires no dependencies). It is currently located <a href="https://github.com/paleolimbot/geoarrow/blob/master/src/internal/geoarrow.hpp" class="external-link">here</a>.</p>
<div class="section level3">
<h3 id="iterating-over-coordinates">Iterating over coordinates<a class="anchor" aria-label="anchor" href="#iterating-over-coordinates"></a>
</h3>
<p>(TODO: Haven’t added this to the GeoArrowArrayView yet)</p>
</div>
<div class="section level3">
<h3 id="using-the-handler">Using the Handler<a class="anchor" aria-label="anchor" href="#using-the-handler"></a>
</h3>
<p>The <code>Handler</code> is a class with methods corresponding to events that occur when looping over coordinates from top to bottom. This style of iteration was inspired by GeoRust’s <a href="https://github.com/georust/geozero" class="external-link">geozero</a> and SAX-style XML parsers. Writing operations as handlers is a good fit for some operations but can be challenging for others. In R, it powers the <code><a href="https://paleolimbot.github.io/wk/reference/wk_handle.html" class="external-link">wk::wk_handle()</a></code> operation which in turn powers many other operations via wk handlers elsewhere. It is particularly useful for operations that iterate forward through all coordinates.</p>
<p>For example, the following subclass of <code>Handler</code> calculates the bounding box of any (arrow array of) geometry it is handed.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="pp">#include </span><span class="im">"../../src/internal/geoarrow-hpp/factory.hpp"</span></span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="kw">using</span> <span class="kw">namespace</span> cpp11;</span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="kw">using</span> <span class="kw">namespace</span> geoarrow;</span>
<span id="cb12-7"><a href="#cb12-7"></a></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="kw">class</span> BboxHandler: <span class="kw">public</span> Handler {</span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="kw">public</span>:</span>
<span id="cb12-10"><a href="#cb12-10"></a>  BboxHandler()</span>
<span id="cb12-11"><a href="#cb12-11"></a>    : xmin(R_PosInf), xmax(R_NegInf),</span>
<span id="cb12-12"><a href="#cb12-12"></a>      ymin(R_PosInf), ymax(R_NegInf) {}</span>
<span id="cb12-13"><a href="#cb12-13"></a></span>
<span id="cb12-14"><a href="#cb12-14"></a></span>
<span id="cb12-15"><a href="#cb12-15"></a>  Handler::Result coord(<span class="at">const</span> <span class="dt">double</span>* coord) {</span>
<span id="cb12-16"><a href="#cb12-16"></a>    xmin = <span class="bu">std::</span>min&lt;<span class="dt">double</span>&gt;(coord[<span class="dv">0</span>], xmin);</span>
<span id="cb12-17"><a href="#cb12-17"></a>    xmax = <span class="bu">std::</span>max&lt;<span class="dt">double</span>&gt;(coord[<span class="dv">0</span>], xmax);</span>
<span id="cb12-18"><a href="#cb12-18"></a>    ymin = <span class="bu">std::</span>min&lt;<span class="dt">double</span>&gt;(coord[<span class="dv">1</span>], ymin);</span>
<span id="cb12-19"><a href="#cb12-19"></a>    ymax = <span class="bu">std::</span>max&lt;<span class="dt">double</span>&gt;(coord[<span class="dv">1</span>], ymax);</span>
<span id="cb12-20"><a href="#cb12-20"></a>    <span class="cf">return</span> Result::CONTINUE;</span>
<span id="cb12-21"><a href="#cb12-21"></a>  }</span>
<span id="cb12-22"><a href="#cb12-22"></a></span>
<span id="cb12-23"><a href="#cb12-23"></a>  <span class="dt">double</span> xmin;</span>
<span id="cb12-24"><a href="#cb12-24"></a>  <span class="dt">double</span> xmax;</span>
<span id="cb12-25"><a href="#cb12-25"></a>  <span class="dt">double</span> ymin;</span>
<span id="cb12-26"><a href="#cb12-26"></a>  <span class="dt">double</span> ymax;</span>
<span id="cb12-27"><a href="#cb12-27"></a>};</span>
<span id="cb12-28"><a href="#cb12-28"></a></span>
<span id="cb12-29"><a href="#cb12-29"></a>[[<span class="at">cpp11</span>::<span class="at">register</span>]]</span>
<span id="cb12-30"><a href="#cb12-30"></a>doubles geoarrow_bbox(sexp schema_xptr, sexp array_data_xptr) {</span>
<span id="cb12-31"><a href="#cb12-31"></a>  <span class="kw">struct</span> ArrowSchema* schema = safe[schema_from_xptr](schema_xptr, <span class="st">"schema"</span>);</span>
<span id="cb12-32"><a href="#cb12-32"></a>  <span class="kw">struct</span> ArrowArray* array_data = safe[array_data_from_xptr](array_data_xptr, <span class="st">"array_data"</span>);</span>
<span id="cb12-33"><a href="#cb12-33"></a></span>
<span id="cb12-34"><a href="#cb12-34"></a>  <span class="bu">std::</span>unique_ptr&lt;ArrayView&gt; view(create_view(schema));</span>
<span id="cb12-35"><a href="#cb12-35"></a>  view-&gt;set_array(array_data);</span>
<span id="cb12-36"><a href="#cb12-36"></a></span>
<span id="cb12-37"><a href="#cb12-37"></a>  BboxHandler handler;</span>
<span id="cb12-38"><a href="#cb12-38"></a>  view-&gt;read_meta(&amp;handler);</span>
<span id="cb12-39"><a href="#cb12-39"></a>  view-&gt;read_features(&amp;handler);</span>
<span id="cb12-40"><a href="#cb12-40"></a>  writable::doubles out = {handler.xmin, handler.xmax, handler.ymin, handler.ymax};</span>
<span id="cb12-41"><a href="#cb12-41"></a>  <span class="cf">return</span> out;</span>
<span id="cb12-42"><a href="#cb12-42"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">geoarrow_bbox</span><span class="op">(</span><span class="va">polygons</span><span class="op">$</span><span class="va">schema</span>, <span class="va">polygons</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span>
<span class="co">#&gt; [1]  Inf -Inf  Inf -Inf</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="metadata">Metadata<a class="anchor" aria-label="anchor" href="#metadata"></a>
</h3>
<p>The geoarrow package uses the <code>Meta</code> class to validate and parse both schema and array objects. It is a wrapper around a <code>struct ArrowSchema</code> that walks its input and extracts pieces in a reasonable format to build on. In most cases you shouldn’t need to extract metadata in compiled code; however, the <code>Meta</code> class is the easiest way to do so if you are in this position.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="pp">#include </span><span class="im">"../../src/internal/geoarrow-hpp/meta.hpp"</span></span>
<span id="cb14-4"><a href="#cb14-4"></a></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="kw">using</span> <span class="kw">namespace</span> cpp11;</span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="kw">using</span> <span class="kw">namespace</span> geoarrow;</span>
<span id="cb14-7"><a href="#cb14-7"></a></span>
<span id="cb14-8"><a href="#cb14-8"></a>[[<span class="at">cpp11</span>::<span class="at">register</span>]]</span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="dt">void</span> geoarrow_metadata_dump(sexp schema_xptr) {</span>
<span id="cb14-10"><a href="#cb14-10"></a>  <span class="kw">struct</span> ArrowSchema* schema = safe[schema_from_xptr](schema_xptr, <span class="st">"schema"</span>);</span>
<span id="cb14-11"><a href="#cb14-11"></a>  Meta meta;</span>
<span id="cb14-12"><a href="#cb14-12"></a>  <span class="cf">if</span> (!meta.set_schema(schema)) {</span>
<span id="cb14-13"><a href="#cb14-13"></a>    stop(<span class="st">"</span><span class="sc">%s</span><span class="st">"</span>, meta.<span class="va">error_</span>);</span>
<span id="cb14-14"><a href="#cb14-14"></a>  }</span>
<span id="cb14-15"><a href="#cb14-15"></a></span>
<span id="cb14-16"><a href="#cb14-16"></a>  <span class="cf">switch</span>(meta.<span class="va">extension_</span>) {</span>
<span id="cb14-17"><a href="#cb14-17"></a>  <span class="cf">case</span> util::Extension::Point:</span>
<span id="cb14-18"><a href="#cb14-18"></a>    Rprintf(<span class="st">"Extension: 'geoarrow.point'</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-19"><a href="#cb14-19"></a>    <span class="cf">break</span>;</span>
<span id="cb14-20"><a href="#cb14-20"></a>  <span class="cf">case</span> util::Extension::Linestring:</span>
<span id="cb14-21"><a href="#cb14-21"></a>    Rprintf(<span class="st">"Extension: 'geoarrow.linestring'</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-22"><a href="#cb14-22"></a>    <span class="cf">break</span>;</span>
<span id="cb14-23"><a href="#cb14-23"></a>  <span class="cf">case</span> util::Extension::Polygon:</span>
<span id="cb14-24"><a href="#cb14-24"></a>    Rprintf(<span class="st">"Extension: 'geoarrow.polygon'</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-25"><a href="#cb14-25"></a>    <span class="cf">break</span>;</span>
<span id="cb14-26"><a href="#cb14-26"></a>  <span class="cf">case</span> util::Extension::MultiPoint:</span>
<span id="cb14-27"><a href="#cb14-27"></a>    Rprintf(<span class="st">"Extension: 'geoarrow.multipoint'</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-28"><a href="#cb14-28"></a>    <span class="cf">break</span>;</span>
<span id="cb14-29"><a href="#cb14-29"></a>  <span class="cf">case</span> util::Extension::MultiLinestring:</span>
<span id="cb14-30"><a href="#cb14-30"></a>    Rprintf(<span class="st">"Extension: 'geoarrow.multilinestring'</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-31"><a href="#cb14-31"></a>    <span class="cf">break</span>;</span>
<span id="cb14-32"><a href="#cb14-32"></a>  <span class="cf">case</span> util::Extension::MultiPolygon:</span>
<span id="cb14-33"><a href="#cb14-33"></a>    Rprintf(<span class="st">"Extension: 'geoarrow.multipolygon'</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-34"><a href="#cb14-34"></a>    <span class="cf">break</span>;</span>
<span id="cb14-35"><a href="#cb14-35"></a>  <span class="cf">case</span> util::Extension::GeometryCollection:</span>
<span id="cb14-36"><a href="#cb14-36"></a>    Rprintf(<span class="st">"Extension: 'geoarrow.geometrycollection'</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-37"><a href="#cb14-37"></a>    <span class="cf">break</span>;</span>
<span id="cb14-38"><a href="#cb14-38"></a></span>
<span id="cb14-39"><a href="#cb14-39"></a>  <span class="cf">default</span>:</span>
<span id="cb14-40"><a href="#cb14-40"></a>    Rprintf(<span class="st">"Extension: other</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-41"><a href="#cb14-41"></a>    <span class="cf">break</span>;</span>
<span id="cb14-42"><a href="#cb14-42"></a>  }</span>
<span id="cb14-43"><a href="#cb14-43"></a></span>
<span id="cb14-44"><a href="#cb14-44"></a>  <span class="cf">switch</span>(meta.<span class="va">storage_type_</span>) {</span>
<span id="cb14-45"><a href="#cb14-45"></a>  <span class="cf">case</span> util::StorageType::FixedSizeList:</span>
<span id="cb14-46"><a href="#cb14-46"></a>    Rprintf(<span class="st">"Storage type: fixed size list</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-47"><a href="#cb14-47"></a>    <span class="cf">break</span>;</span>
<span id="cb14-48"><a href="#cb14-48"></a>  <span class="cf">case</span> util::StorageType::Struct:</span>
<span id="cb14-49"><a href="#cb14-49"></a>    Rprintf(<span class="st">"Storage type: struct</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-50"><a href="#cb14-50"></a>    <span class="cf">break</span>;</span>
<span id="cb14-51"><a href="#cb14-51"></a>  <span class="cf">case</span> util::StorageType::List:</span>
<span id="cb14-52"><a href="#cb14-52"></a>    Rprintf(<span class="st">"Storage type: list</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-53"><a href="#cb14-53"></a>    <span class="cf">break</span>;</span>
<span id="cb14-54"><a href="#cb14-54"></a></span>
<span id="cb14-55"><a href="#cb14-55"></a>  <span class="cf">default</span>:</span>
<span id="cb14-56"><a href="#cb14-56"></a>    Rprintf(<span class="st">"Storage type: other</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-57"><a href="#cb14-57"></a>  }</span>
<span id="cb14-58"><a href="#cb14-58"></a></span>
<span id="cb14-59"><a href="#cb14-59"></a>  Rprintf(<span class="st">"Dimensions: '</span><span class="sc">%s</span><span class="st">'</span><span class="sc">\n</span><span class="st">"</span>, meta.<span class="va">dim_</span>);</span>
<span id="cb14-60"><a href="#cb14-60"></a></span>
<span id="cb14-61"><a href="#cb14-61"></a>  <span class="cf">if</span> (meta.<span class="va">crs_size_</span> &gt; <span class="dv">0</span>) {</span>
<span id="cb14-62"><a href="#cb14-62"></a>    <span class="bu">std::</span>string crs(meta.<span class="va">crs_</span>, meta.<span class="va">crs_size_</span>);</span>
<span id="cb14-63"><a href="#cb14-63"></a>    Rprintf(<span class="st">"CRS: '</span><span class="sc">%s</span><span class="st">'</span><span class="sc">\n</span><span class="st">"</span>, crs.c_str());</span>
<span id="cb14-64"><a href="#cb14-64"></a>  }</span>
<span id="cb14-65"><a href="#cb14-65"></a></span>
<span id="cb14-66"><a href="#cb14-66"></a>  <span class="cf">if</span> (meta.<span class="va">edges_</span> == util::Edges::Spherical) {</span>
<span id="cb14-67"><a href="#cb14-67"></a>    Rprintf(<span class="st">"Spherical edges!</span><span class="sc">\n</span><span class="st">"</span>);</span>
<span id="cb14-68"><a href="#cb14-68"></a>  }</span>
<span id="cb14-69"><a href="#cb14-69"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">geoarrow_metadata_dump</span><span class="op">(</span><span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span>
<span class="co">#&gt; Extension: 'geoarrow.point'</span>
<span class="co">#&gt; Storage type: fixed size list</span>
<span class="co">#&gt; Dimensions: 'xy'</span>
<span class="fu">geoarrow_metadata_dump</span><span class="op">(</span><span class="va">linestrings</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span>
<span class="co">#&gt; Extension: 'geoarrow.linestring'</span>
<span class="co">#&gt; Storage type: list</span>
<span class="co">#&gt; Dimensions: 'xy'</span>
<span class="fu">geoarrow_metadata_dump</span><span class="op">(</span>
  <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
    <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="st">"EPSG:1234"</span>, geodesic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_linestring</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span><span class="op">$</span><span class="va">schema</span>
<span class="op">)</span>
<span class="co">#&gt; Extension: other</span>
<span class="co">#&gt; Storage type: other</span>
<span class="co">#&gt; Dimensions: 'xy'</span>
<span class="co">#&gt; CRS: 'EPSG:1234'</span>
<span class="co">#&gt; Spherical edges!</span></code></pre></div>
<p>This also will give a reasonable error for invalid objects:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">points_invalid</span> <span class="op">&lt;-</span> <span class="va">points</span>
<span class="va">points_invalid</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"xyzm"</span>
<span class="fu">geoarrow_metadata_dump</span><span class="op">(</span><span class="va">points_invalid</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span>
<span class="co">#&gt; Error: Expected geoarrow.point with dimensions 'xyzm' to have width 4 but found width 2</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="reading-geoarrow-arrays-in-c">Reading geoarrow arrays in C<a class="anchor" aria-label="anchor" href="#reading-geoarrow-arrays-in-c"></a>
</h2>
<p>If you need to deal with arbitrary vectors of that may have different types or different point encodings, you should <code>#include "geoarrow.hpp"</code> and use the helper functions provided there; however, the geoarrow format was designed to be accessible from C code without helpers. If you can make some assumptions about the geometry type and storage type of your input but still want the speed of compiled code, using the C structures directly may be a good fit. As an example, I’m going to print coordinates with information about the containing structures.</p>
<div class="section level3">
<h3 id="points">Points<a class="anchor" aria-label="anchor" href="#points"></a>
</h3>
<p>For points, you need three pieces of information: the length, the initial offset into the array, and the buffer of <code>double</code>s containing the coordinates.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a>SEXP c_point_print(SEXP array_data_xptr) {</span>
<span id="cb17-5"><a href="#cb17-5"></a>  <span class="kw">struct</span> ArrowArray* array_data = array_data_from_xptr(array_data_xptr, <span class="st">"array_data"</span>);</span>
<span id="cb17-6"><a href="#cb17-6"></a></span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="dt">int</span> coord_size = <span class="dv">2</span>;</span>
<span id="cb17-8"><a href="#cb17-8"></a>  <span class="dt">double</span>* coords = (<span class="dt">double</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb17-9"><a href="#cb17-9"></a>  coords = coords + (array_data-&gt;offset) * coord_size;</span>
<span id="cb17-10"><a href="#cb17-10"></a></span>
<span id="cb17-11"><a href="#cb17-11"></a>  <span class="dt">double</span>* coord;</span>
<span id="cb17-12"><a href="#cb17-12"></a>  <span class="cf">for</span> (<span class="dt">int64_t</span> point_id = <span class="dv">0</span>; point_id &lt; array_data-&gt;length; point_id++) {</span>
<span id="cb17-13"><a href="#cb17-13"></a>    coord = coords + (point_id * coord_size);</span>
<span id="cb17-14"><a href="#cb17-14"></a>    Rprintf(<span class="st">"point[%d] (%g %g)</span><span class="sc">\n</span><span class="st">"</span>, point_id, coord[<span class="dv">0</span>], coord[<span class="dv">1</span>]);</span>
<span id="cb17-15"><a href="#cb17-15"></a>  }</span>
<span id="cb17-16"><a href="#cb17-16"></a></span>
<span id="cb17-17"><a href="#cb17-17"></a>  <span class="cf">return</span> R_NilValue;</span>
<span id="cb17-18"><a href="#cb17-18"></a>}</span></code></pre></div>
<p>Depending on whether or not you have access to a higher-level runtime, you probably want to validate a few things about the schema before accessing elements of the array.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">point_print</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paleolimbot.github.io/narrow/reference/narrow_array.html" class="external-link">as_narrow_array</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span>
    <span class="va">x</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+w:2"</span>,
    <span class="va">x</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"g"</span>
  <span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_point_print"</span>, <span class="va">x</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">point_print</span><span class="op">(</span><span class="va">points</span><span class="op">)</span>
<span class="co">#&gt; point[0] (30 10)</span>
<span class="co">#&gt; point[1] (40 30)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="linestrings">Linestrings<a class="anchor" aria-label="anchor" href="#linestrings"></a>
</h3>
<p>In addition to all the information about a point, you also need the offsets into the point array from the outer linestring.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a>SEXP c_linestring_print(SEXP array_data_xptr) {</span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="kw">struct</span> ArrowArray* array_data = array_data_from_xptr(array_data_xptr, <span class="st">"array_data"</span>);</span>
<span id="cb19-6"><a href="#cb19-6"></a></span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="dt">int</span> coord_size = <span class="dv">2</span>;</span>
<span id="cb19-8"><a href="#cb19-8"></a>  <span class="dt">double</span>* coords = (<span class="dt">double</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb19-9"><a href="#cb19-9"></a>  <span class="dt">int32_t</span>* coord_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb19-10"><a href="#cb19-10"></a></span>
<span id="cb19-11"><a href="#cb19-11"></a>  coord_offsets = coord_offsets + array_data-&gt;offset;</span>
<span id="cb19-12"><a href="#cb19-12"></a>  coords = coords + coord_offsets[<span class="dv">0</span>];</span>
<span id="cb19-13"><a href="#cb19-13"></a></span>
<span id="cb19-14"><a href="#cb19-14"></a>  <span class="dt">double</span>* coord;</span>
<span id="cb19-15"><a href="#cb19-15"></a>  <span class="cf">for</span> (<span class="dt">int64_t</span> line_id = <span class="dv">0</span>; line_id &lt; array_data-&gt;length; line_id++) {</span>
<span id="cb19-16"><a href="#cb19-16"></a>    <span class="dt">int32_t</span> n_coords = coord_offsets[line_id + <span class="dv">1</span>] - coord_offsets[line_id];</span>
<span id="cb19-17"><a href="#cb19-17"></a></span>
<span id="cb19-18"><a href="#cb19-18"></a>    <span class="cf">for</span> (<span class="dt">int32_t</span> point_id = <span class="dv">0</span>; point_id &lt; n_coords; point_id++) {</span>
<span id="cb19-19"><a href="#cb19-19"></a>      coord = coords + coord_size * (coord_offsets[line_id] + point_id);</span>
<span id="cb19-20"><a href="#cb19-20"></a>      Rprintf(<span class="st">"linestring[%d]-&gt;point[%d] (%g %g)</span><span class="sc">\n</span><span class="st">"</span>, line_id, point_id, coord[<span class="dv">0</span>], coord[<span class="dv">1</span>]);</span>
<span id="cb19-21"><a href="#cb19-21"></a>    }</span>
<span id="cb19-22"><a href="#cb19-22"></a>  }</span>
<span id="cb19-23"><a href="#cb19-23"></a></span>
<span id="cb19-24"><a href="#cb19-24"></a>  <span class="cf">return</span> R_NilValue;</span>
<span id="cb19-25"><a href="#cb19-25"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linestring_print</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paleolimbot.github.io/narrow/reference/narrow_array.html" class="external-link">as_narrow_array</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span>
    <span class="va">x</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
    <span class="va">x</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+w:2"</span>,
    <span class="va">x</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"g"</span>
  <span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_linestring_print"</span>, <span class="va">x</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">linestring_print</span><span class="op">(</span><span class="va">linestrings</span><span class="op">)</span>
<span class="co">#&gt; linestring[0]-&gt;point[0] (30 10)</span>
<span class="co">#&gt; linestring[0]-&gt;point[1] (10 30)</span>
<span class="co">#&gt; linestring[0]-&gt;point[2] (40 40)</span>
<span class="co">#&gt; linestring[1]-&gt;point[0] (0 0)</span>
<span class="co">#&gt; linestring[1]-&gt;point[1] (10 5)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="polygons">Polygons<a class="anchor" aria-label="anchor" href="#polygons"></a>
</h3>
<p>In addition to all the information about a linestring, you also need the offsets into the rings array from the outer polygon.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb21-3"><a href="#cb21-3"></a></span>
<span id="cb21-4"><a href="#cb21-4"></a>SEXP c_polygon_print(SEXP array_data_xptr) {</span>
<span id="cb21-5"><a href="#cb21-5"></a>  <span class="kw">struct</span> ArrowArray* array_data = array_data_from_xptr(array_data_xptr, <span class="st">"array_data"</span>);</span>
<span id="cb21-6"><a href="#cb21-6"></a></span>
<span id="cb21-7"><a href="#cb21-7"></a>  <span class="dt">int</span> coord_size = <span class="dv">2</span>;</span>
<span id="cb21-8"><a href="#cb21-8"></a>  <span class="dt">double</span>* coords = (<span class="dt">double</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb21-9"><a href="#cb21-9"></a>  <span class="dt">int32_t</span>* coord_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb21-10"><a href="#cb21-10"></a>  <span class="dt">int32_t</span>* ring_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb21-11"><a href="#cb21-11"></a></span>
<span id="cb21-12"><a href="#cb21-12"></a>  ring_offsets = ring_offsets + array_data-&gt;offset;</span>
<span id="cb21-13"><a href="#cb21-13"></a>  coord_offsets = coord_offsets + ring_offsets[<span class="dv">0</span>];</span>
<span id="cb21-14"><a href="#cb21-14"></a>  coords = coords + coord_offsets[<span class="dv">0</span>];</span>
<span id="cb21-15"><a href="#cb21-15"></a></span>
<span id="cb21-16"><a href="#cb21-16"></a>  <span class="dt">double</span>* coord;</span>
<span id="cb21-17"><a href="#cb21-17"></a>  <span class="dt">int32_t</span>* coord_offset;</span>
<span id="cb21-18"><a href="#cb21-18"></a>  <span class="cf">for</span> (<span class="dt">int64_t</span> poly_id = <span class="dv">0</span>; poly_id &lt; array_data-&gt;length; poly_id++) {</span>
<span id="cb21-19"><a href="#cb21-19"></a>    <span class="dt">int32_t</span> n_rings = ring_offsets[poly_id + <span class="dv">1</span>] - ring_offsets[poly_id];</span>
<span id="cb21-20"><a href="#cb21-20"></a>    coord_offset = coord_offsets + ring_offsets[poly_id];</span>
<span id="cb21-21"><a href="#cb21-21"></a></span>
<span id="cb21-22"><a href="#cb21-22"></a>    <span class="cf">for</span> (<span class="dt">int32_t</span> ring_id = <span class="dv">0</span>; ring_id &lt; n_rings; ring_id++) {</span>
<span id="cb21-23"><a href="#cb21-23"></a>      <span class="dt">int32_t</span> n_coords = coord_offset[ring_id + <span class="dv">1</span>] - coord_offset[ring_id];</span>
<span id="cb21-24"><a href="#cb21-24"></a></span>
<span id="cb21-25"><a href="#cb21-25"></a>      <span class="cf">for</span> (<span class="dt">int32_t</span> point_id = <span class="dv">0</span>; point_id &lt; n_coords; point_id++) {</span>
<span id="cb21-26"><a href="#cb21-26"></a>        coord = coords + (coord_size * (coord_offset[ring_id] + point_id));</span>
<span id="cb21-27"><a href="#cb21-27"></a>        Rprintf(</span>
<span id="cb21-28"><a href="#cb21-28"></a>          <span class="st">"polygon[%d]-&gt;ring[%d]-&gt;point[%d] (%g %g)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb21-29"><a href="#cb21-29"></a>          poly_id, ring_id, point_id, coord[<span class="dv">0</span>], coord[<span class="dv">1</span>]);</span>
<span id="cb21-30"><a href="#cb21-30"></a>      }</span>
<span id="cb21-31"><a href="#cb21-31"></a>    }</span>
<span id="cb21-32"><a href="#cb21-32"></a>  }</span>
<span id="cb21-33"><a href="#cb21-33"></a></span>
<span id="cb21-34"><a href="#cb21-34"></a>  <span class="cf">return</span> R_NilValue;</span>
<span id="cb21-35"><a href="#cb21-35"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">polygon_print</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paleolimbot.github.io/narrow/reference/narrow_array.html" class="external-link">as_narrow_array</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span>
    <span class="va">x</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
    <span class="va">x</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
    <span class="va">x</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+w:2"</span>,
    <span class="va">x</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"g"</span>
  <span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_polygon_print"</span>, <span class="va">x</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">polygon_print</span><span class="op">(</span><span class="va">polygons</span><span class="op">)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[0] (30 10)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[1] (40 40)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[2] (20 40)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[3] (10 20)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[4] (30 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[0] (35 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[1] (45 45)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[2] (15 40)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[3] (10 20)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[4] (35 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[0] (20 30)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[1] (35 35)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[2] (30 20)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[3] (20 30)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multipoints">Multipoints<a class="anchor" aria-label="anchor" href="#multipoints"></a>
</h3>
<p>Iterating over multipoints requires the same code and assertions as for linestrings:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">linestring_print</span><span class="op">(</span><span class="va">multipoints</span><span class="op">)</span>
<span class="co">#&gt; linestring[0]-&gt;point[0] (0 1)</span>
<span class="co">#&gt; linestring[0]-&gt;point[1] (2 3)</span>
<span class="co">#&gt; linestring[1]-&gt;point[0] (0 0)</span>
<span class="co">#&gt; linestring[1]-&gt;point[1] (3 8)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multilinestrings">Multilinestrings<a class="anchor" aria-label="anchor" href="#multilinestrings"></a>
</h3>
<p>Iterating over multilinestrings requires the same code and assertions as for polygons:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">polygon_print</span><span class="op">(</span><span class="va">multilinestrings</span><span class="op">)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[0] (30 10)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[1] (40 40)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[2] (20 40)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[3] (10 20)</span>
<span class="co">#&gt; polygon[0]-&gt;ring[0]-&gt;point[4] (30 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[0] (35 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[1] (45 45)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[2] (15 40)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[3] (10 20)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[0]-&gt;point[4] (35 10)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[0] (20 30)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[1] (35 35)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[2] (30 20)</span>
<span class="co">#&gt; polygon[1]-&gt;ring[1]-&gt;point[3] (20 30)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multipolygons">Multipolygons<a class="anchor" aria-label="anchor" href="#multipolygons"></a>
</h3>
<p>In addition to all the information about a polygon, you also need the offsets into the geometries array from the outer collection.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb25-1"><a href="#cb25-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb25-3"><a href="#cb25-3"></a></span>
<span id="cb25-4"><a href="#cb25-4"></a>SEXP c_multipolygon_print(SEXP array_data_xptr) {</span>
<span id="cb25-5"><a href="#cb25-5"></a>  <span class="kw">struct</span> ArrowArray* array_data = array_data_from_xptr(array_data_xptr, <span class="st">"array_data"</span>);</span>
<span id="cb25-6"><a href="#cb25-6"></a></span>
<span id="cb25-7"><a href="#cb25-7"></a>  <span class="dt">int</span> coord_size = <span class="dv">2</span>;</span>
<span id="cb25-8"><a href="#cb25-8"></a>  <span class="dt">double</span>* coords = (<span class="dt">double</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb25-9"><a href="#cb25-9"></a>  <span class="dt">int32_t</span>* coord_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb25-10"><a href="#cb25-10"></a>  <span class="dt">int32_t</span>* ring_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;children[<span class="dv">0</span>]-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb25-11"><a href="#cb25-11"></a>  <span class="dt">int32_t</span>* geom_offsets = (<span class="dt">int32_t</span>*) array_data-&gt;buffers[<span class="dv">1</span>];</span>
<span id="cb25-12"><a href="#cb25-12"></a></span>
<span id="cb25-13"><a href="#cb25-13"></a>  geom_offsets = geom_offsets + array_data-&gt;offset;</span>
<span id="cb25-14"><a href="#cb25-14"></a>  ring_offsets = ring_offsets + geom_offsets[<span class="dv">0</span>];</span>
<span id="cb25-15"><a href="#cb25-15"></a>  coord_offsets = coord_offsets + ring_offsets[<span class="dv">0</span>];</span>
<span id="cb25-16"><a href="#cb25-16"></a>  coords = coords + coord_offsets[<span class="dv">0</span>];</span>
<span id="cb25-17"><a href="#cb25-17"></a></span>
<span id="cb25-18"><a href="#cb25-18"></a>  <span class="dt">double</span>* coord;</span>
<span id="cb25-19"><a href="#cb25-19"></a>  <span class="dt">int32_t</span>* coord_offset;</span>
<span id="cb25-20"><a href="#cb25-20"></a>  <span class="dt">int32_t</span>* ring_offset;</span>
<span id="cb25-21"><a href="#cb25-21"></a>  <span class="cf">for</span> (<span class="dt">int64_t</span> multi_id = <span class="dv">0</span>; multi_id &lt; array_data-&gt;length; multi_id++) {</span>
<span id="cb25-22"><a href="#cb25-22"></a>    <span class="dt">int32_t</span> n_geoms = geom_offsets[multi_id + <span class="dv">1</span>] - geom_offsets[multi_id];</span>
<span id="cb25-23"><a href="#cb25-23"></a>    ring_offset = ring_offsets + geom_offsets[multi_id];</span>
<span id="cb25-24"><a href="#cb25-24"></a></span>
<span id="cb25-25"><a href="#cb25-25"></a>    <span class="cf">for</span> (<span class="dt">int32_t</span> poly_id = <span class="dv">0</span>; poly_id &lt; n_geoms; poly_id++) {</span>
<span id="cb25-26"><a href="#cb25-26"></a>      <span class="dt">int32_t</span> n_rings = ring_offset[poly_id + <span class="dv">1</span>] - ring_offset[poly_id];</span>
<span id="cb25-27"><a href="#cb25-27"></a>      coord_offset = coord_offsets + ring_offsets[poly_id];</span>
<span id="cb25-28"><a href="#cb25-28"></a></span>
<span id="cb25-29"><a href="#cb25-29"></a>      <span class="cf">for</span> (<span class="dt">int32_t</span> ring_id = <span class="dv">0</span>; ring_id &lt; n_rings; ring_id++) {</span>
<span id="cb25-30"><a href="#cb25-30"></a>        <span class="dt">int32_t</span> n_coords = coord_offset[ring_id + <span class="dv">1</span>] - coord_offset[ring_id];</span>
<span id="cb25-31"><a href="#cb25-31"></a></span>
<span id="cb25-32"><a href="#cb25-32"></a>        <span class="cf">for</span> (<span class="dt">int32_t</span> point_id = <span class="dv">0</span>; point_id &lt; n_coords; point_id++) {</span>
<span id="cb25-33"><a href="#cb25-33"></a>          coord = coords + (coord_size * (coord_offset[ring_id] + point_id));</span>
<span id="cb25-34"><a href="#cb25-34"></a>          Rprintf(</span>
<span id="cb25-35"><a href="#cb25-35"></a>            <span class="st">"multipolygon[%d]-&gt;polygon[%d]-&gt;ring[%d]-&gt;point[%d] (%g %g)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb25-36"><a href="#cb25-36"></a>            multi_id, poly_id, ring_id, point_id, coord[<span class="dv">0</span>], coord[<span class="dv">1</span>]);</span>
<span id="cb25-37"><a href="#cb25-37"></a>        }</span>
<span id="cb25-38"><a href="#cb25-38"></a>      }</span>
<span id="cb25-39"><a href="#cb25-39"></a>    }</span>
<span id="cb25-40"><a href="#cb25-40"></a>  }</span>
<span id="cb25-41"><a href="#cb25-41"></a></span>
<span id="cb25-42"><a href="#cb25-42"></a>  <span class="cf">return</span> R_NilValue;</span>
<span id="cb25-43"><a href="#cb25-43"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">multipolygon_print</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paleolimbot.github.io/narrow/reference/narrow_array.html" class="external-link">as_narrow_array</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span>
    <span class="va">x</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
    <span class="va">x</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
    <span class="va">x</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+l"</span>,
    <span class="va">x</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"+w:2"</span>,
    <span class="va">x</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">format</span> <span class="op">==</span> <span class="st">"g"</span>
  <span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_multipolygon_print"</span>, <span class="va">x</span><span class="op">$</span><span class="va">array_data</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">multipolygon_print</span><span class="op">(</span><span class="va">multipolygons</span><span class="op">)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[0]-&gt;ring[0]-&gt;point[0] (30 20)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[0]-&gt;ring[0]-&gt;point[1] (45 40)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[0]-&gt;ring[0]-&gt;point[2] (10 40)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[0]-&gt;ring[0]-&gt;point[3] (30 20)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[1]-&gt;ring[0]-&gt;point[0] (15 5)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[1]-&gt;ring[0]-&gt;point[1] (40 10)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[1]-&gt;ring[0]-&gt;point[2] (10 20)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[1]-&gt;ring[0]-&gt;point[3] (5 10)</span>
<span class="co">#&gt; multipolygon[0]-&gt;polygon[1]-&gt;ring[0]-&gt;point[4] (15 5)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[0]-&gt;ring[0]-&gt;point[0] (30 20)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[0]-&gt;ring[0]-&gt;point[1] (45 40)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[0]-&gt;ring[0]-&gt;point[2] (10 40)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[0]-&gt;ring[0]-&gt;point[3] (30 20)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[0]-&gt;point[0] (15 5)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[0]-&gt;point[1] (40 10)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[0]-&gt;point[2] (10 20)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[0]-&gt;point[3] (5 10)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[0]-&gt;point[4] (15 5)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[1]-&gt;point[0] (40 40)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[1]-&gt;point[1] (20 45)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[1]-&gt;point[2] (45 30)</span>
<span class="co">#&gt; multipolygon[1]-&gt;polygon[1]-&gt;ring[1]-&gt;point[3] (40 40)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="metadata-1">Metadata<a class="anchor" aria-label="anchor" href="#metadata-1"></a>
</h3>
<p>The easiest way to inspect the schema, which encodes the storage type and extra geo-specific extension metadata, is to do it before you drop into C. In particular, <code><a href="https://paleolimbot.github.io/wk/reference/wk_meta.html" class="external-link">wk::wk_vector_meta()</a></code> has been implemented for geoarrow arrays in such a way that it will (1) validate the schema to let you make stronger assumptions about the C structures you are given and (2) deserialize and extract the metadata you might need to reduce the number of problems you have to solve in C.</p>
<p>If you really do need to do this in compiled code, you can access the <code>struct ArrowSchema</code> directly. For example, to extract the dimensions from C, you can do this:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb27-3"><a href="#cb27-3"></a></span>
<span id="cb27-4"><a href="#cb27-4"></a>SEXP c_point_dimensions(SEXP schema_xptr) {</span>
<span id="cb27-5"><a href="#cb27-5"></a>  <span class="kw">struct</span> ArrowSchema* schema = schema_from_xptr(schema_xptr, <span class="st">"schema"</span>);</span>
<span id="cb27-6"><a href="#cb27-6"></a>  <span class="cf">return</span> Rf_mkString(schema-&gt;children[<span class="dv">0</span>]-&gt;name);</span>
<span id="cb27-7"><a href="#cb27-7"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_point_dimensions"</span>, <span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span>
<span class="co">#&gt; [1] "xy"</span>
<span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_point_dimensions"</span>, <span class="va">linestrings</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; [1] "xy"</span></code></pre></div>
<p>If you need extension metadata from C you will have to iterate over the metadata field AND the extension metadata field. These are both encoded in the same way (by design). This gets verbose quickly, but if you really need to do it you can do so in about 50 lines. The important thing to note is that none of the names or values are null-terminated in the metadata fields.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb29-1"><a href="#cb29-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="pp">#include </span><span class="im">"narrow.h"</span></span>
<span id="cb29-3"><a href="#cb29-3"></a></span>
<span id="cb29-4"><a href="#cb29-4"></a>SEXP c_dump_metadata(SEXP schema_xptr) {</span>
<span id="cb29-5"><a href="#cb29-5"></a>  <span class="kw">struct</span> ArrowSchema* schema = schema_from_xptr(schema_xptr, <span class="st">"schema"</span>);</span>
<span id="cb29-6"><a href="#cb29-6"></a></span>
<span id="cb29-7"><a href="#cb29-7"></a>  <span class="dt">const</span> <span class="dt">char</span>* metadata = schema-&gt;metadata;</span>
<span id="cb29-8"><a href="#cb29-8"></a></span>
<span id="cb29-9"><a href="#cb29-9"></a>  <span class="dt">int64_t</span> pos = <span class="dv">0</span>;</span>
<span id="cb29-10"><a href="#cb29-10"></a>  <span class="dt">int32_t</span> n, m, name_len, value_len;</span>
<span id="cb29-11"><a href="#cb29-11"></a>  memcpy(&amp;n, metadata + pos, <span class="kw">sizeof</span>(<span class="dt">int32_t</span>));</span>
<span id="cb29-12"><a href="#cb29-12"></a>  pos += <span class="kw">sizeof</span>(<span class="dt">int32_t</span>);</span>
<span id="cb29-13"><a href="#cb29-13"></a></span>
<span id="cb29-14"><a href="#cb29-14"></a>  <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; n; i++) {</span>
<span id="cb29-15"><a href="#cb29-15"></a>    memcpy(&amp;name_len, metadata + pos, <span class="kw">sizeof</span>(<span class="dt">int32_t</span>));</span>
<span id="cb29-16"><a href="#cb29-16"></a>    pos += <span class="kw">sizeof</span>(<span class="dt">int32_t</span>);</span>
<span id="cb29-17"><a href="#cb29-17"></a></span>
<span id="cb29-18"><a href="#cb29-18"></a>    <span class="dt">const</span> <span class="dt">char</span>* name = metadata + pos;</span>
<span id="cb29-19"><a href="#cb29-19"></a>    pos += name_len;</span>
<span id="cb29-20"><a href="#cb29-20"></a></span>
<span id="cb29-21"><a href="#cb29-21"></a>    memcpy(&amp;value_len, metadata + pos, <span class="kw">sizeof</span>(<span class="dt">int32_t</span>));</span>
<span id="cb29-22"><a href="#cb29-22"></a>    pos += <span class="kw">sizeof</span>(<span class="dt">int32_t</span>);</span>
<span id="cb29-23"><a href="#cb29-23"></a></span>
<span id="cb29-24"><a href="#cb29-24"></a>    <span class="cf">if</span> (name_len &gt;= <span class="dv">20</span> &amp;&amp; strncmp(name, <span class="st">"ARROW:extension:name"</span>, <span class="dv">20</span>) == <span class="dv">0</span>) {</span>
<span id="cb29-25"><a href="#cb29-25"></a>        <span class="dt">const</span> <span class="dt">char</span>* value = metadata + pos;</span>
<span id="cb29-26"><a href="#cb29-26"></a>        pos += value_len;</span>
<span id="cb29-27"><a href="#cb29-27"></a></span>
<span id="cb29-28"><a href="#cb29-28"></a>        Rprintf(<span class="st">"ARROW:extension:name: '%.*s'</span><span class="sc">\n</span><span class="st">"</span>, value_len, value);</span>
<span id="cb29-29"><a href="#cb29-29"></a></span>
<span id="cb29-30"><a href="#cb29-30"></a>    } <span class="cf">else</span> <span class="cf">if</span> (name_len &gt;= <span class="dv">24</span> &amp;&amp; strncmp(name, <span class="st">"ARROW:extension:metadata"</span>, <span class="dv">24</span>) == <span class="dv">0</span>) {</span>
<span id="cb29-31"><a href="#cb29-31"></a>      memcpy(&amp;m, metadata + pos, <span class="kw">sizeof</span>(<span class="dt">int32_t</span>));</span>
<span id="cb29-32"><a href="#cb29-32"></a>      pos += <span class="kw">sizeof</span>(<span class="dt">int32_t</span>);</span>
<span id="cb29-33"><a href="#cb29-33"></a></span>
<span id="cb29-34"><a href="#cb29-34"></a>      <span class="cf">for</span> (<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; m; j++) {</span>
<span id="cb29-35"><a href="#cb29-35"></a>        memcpy(&amp;name_len, metadata + pos, <span class="kw">sizeof</span>(<span class="dt">int32_t</span>));</span>
<span id="cb29-36"><a href="#cb29-36"></a>        pos += <span class="kw">sizeof</span>(<span class="dt">int32_t</span>);</span>
<span id="cb29-37"><a href="#cb29-37"></a></span>
<span id="cb29-38"><a href="#cb29-38"></a>        <span class="dt">const</span> <span class="dt">char</span>* ext_name = metadata + pos;</span>
<span id="cb29-39"><a href="#cb29-39"></a>        pos += name_len;</span>
<span id="cb29-40"><a href="#cb29-40"></a></span>
<span id="cb29-41"><a href="#cb29-41"></a>        memcpy(&amp;value_len, metadata + pos, <span class="kw">sizeof</span>(<span class="dt">int32_t</span>));</span>
<span id="cb29-42"><a href="#cb29-42"></a>        pos += <span class="kw">sizeof</span>(<span class="dt">int32_t</span>);</span>
<span id="cb29-43"><a href="#cb29-43"></a></span>
<span id="cb29-44"><a href="#cb29-44"></a>        <span class="dt">const</span> <span class="dt">char</span>* ext_value = metadata + pos;</span>
<span id="cb29-45"><a href="#cb29-45"></a>        pos += value_len;</span>
<span id="cb29-46"><a href="#cb29-46"></a></span>
<span id="cb29-47"><a href="#cb29-47"></a>        <span class="cf">if</span> (name_len == <span class="dv">0</span> || value_len == <span class="dv">0</span>) {</span>
<span id="cb29-48"><a href="#cb29-48"></a>            <span class="cf">continue</span>;</span>
<span id="cb29-49"><a href="#cb29-49"></a>        }</span>
<span id="cb29-50"><a href="#cb29-50"></a></span>
<span id="cb29-51"><a href="#cb29-51"></a>        Rprintf(</span>
<span id="cb29-52"><a href="#cb29-52"></a>          <span class="st">"ARROW:extension:metadata/%.*s: '%.*s'</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb29-53"><a href="#cb29-53"></a>          name_len, ext_name, value_len, ext_value);</span>
<span id="cb29-54"><a href="#cb29-54"></a>      }</span>
<span id="cb29-55"><a href="#cb29-55"></a>    } <span class="cf">else</span> {</span>
<span id="cb29-56"><a href="#cb29-56"></a>      pos += value_len;</span>
<span id="cb29-57"><a href="#cb29-57"></a>      <span class="cf">continue</span>;</span>
<span id="cb29-58"><a href="#cb29-58"></a>    }</span>
<span id="cb29-59"><a href="#cb29-59"></a>  }</span>
<span id="cb29-60"><a href="#cb29-60"></a></span>
<span id="cb29-61"><a href="#cb29-61"></a>  <span class="cf">return</span> R_NilValue;</span>
<span id="cb29-62"><a href="#cb29-62"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_dump_metadata"</span>, <span class="va">points</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; ARROW:extension:name: 'geoarrow.point'</span>

<span class="va">with_crs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="st">"EPSG:1234"</span><span class="op">)</span>,
  schema <span class="op">=</span> <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_point</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="st">"c_dump_metadata"</span>, <span class="va">with_crs</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; ARROW:extension:name: 'geoarrow.point'</span>
<span class="co">#&gt; ARROW:extension:metadata/crs: 'EPSG:1234'</span></code></pre></div>
<p>If you’re in R or another higher-level runtime, the preferred approach is to extract the information you need before calling low-level compiled code (or to use the geoarrow.hpp helper).</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Dewey Dunnington.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="geoarrow">
<title>Geometry storage formats in geoarrow • geoarrow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Geometry storage formats in geoarrow">
<meta property="og:description" content="geoarrow">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">geoarrow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/geoarrow.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/development.html">C and C++ development guide</a>
    <a class="dropdown-item" href="../articles/format.html">Geometry storage formats in geoarrow</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="format_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Geometry storage formats in geoarrow</h1>
            
      
      
      <div class="d-none name"><code>format.Rmd</code></div>
    </div>

    
    
<p>The ability to <a href="geoarrow.html">query large datasets using the Arrow compute engine</a> was the primary motivator for geoarrow; however, this capability depends on efficient storage of geospatial data in file formats that work well with Arrow like <a href="https://www.jumpingrivers.com/blog/parquet-file-format-big-data-r/" class="external-link">Parquet</a> and <a href="https://arrow.apache.org/docs/python/feather.html" class="external-link">Feather</a>. Several previously defined formats to store geometries in text- and/or binary-based file exist; however, each of these is difficult to incorporate into Parquet and/or Feather files without compromising the advantages of the Arrow columnar format that we wanted to leverage. In particular, we wanted O(1) access to coordinate values and to be able to pass geometry vectors around using the <a href="https://arrow.apache.org/docs/format/CDataInterface.html" class="external-link">C data interface</a> in a way that didn’t require readers to implement their own <a href="https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry#Well-known_binary" class="external-link">WKB</a> parser (or any other parser).</p>
<p>We’ll use the geoarrow and <a href="https://arrow.apache.org/docs/r/" class="external-link">arrow</a> packages to demonstrate the structure and metadata of these types:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/geoarrow/">geoarrow</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="metadata">Metadata<a class="anchor" aria-label="anchor" href="#metadata"></a>
</h2>
<p>All geoarrow arrays carry an extension type with a “geoarrow.” prefix (via the field-level <code>ARROW:extension:name</code> metadata key) and extension metadata (via the field-level <code>ARROW:extension:metadata</code> key). The extension metadata contains key/value pairs encoded in the same format as specified for <a href="https://arrow.apache.org/docs/format/CDataInterface.html#c.ArrowSchema.metadata" class="external-link">metadata in the C data interface</a>. This format was chosen to allow readers to access this information without having to vendor a base64 decoder or JSON parser. Currently supported keys are:</p>
<ul>
<li>
<code>crs</code>: Contains a serialized version of the coordinate reference system as WKT2 (previously known as WKT2:2019). The string is interpreted using UTF-8 encoding.</li>
<li>
<code>edges</code>: A value of <code>"spherical"</code> instructs readers that edges should be interpolated along a spherical path rather than a Cartesian one (i.e., for lossless conversion to and from <a href="https://s2geometry.io/" class="external-link">S2</a> and/or <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/geography_functions" class="external-link">BigQuery geography</a>; otherwise, edges will be interpreted as planar. The <code>edges</code> key must be <code>"spherical"</code> or the key should be omitted. A future value of “ellipsoidal” may be permitted if libraries to support such edges become available.</li>
</ul>
<p>The keys should appear in the order listed above. Empty metadata should be encoded as four zero bytes (i.e., the 32-bit integer <code>0x00 0x00 0x00 0x00</code>, indicating that there are zero metadata keys) rather than omitted. These constraints are in place to ensure that type equality can be checked without deserializing the <code>ARROW:extension:metadata</code> field.</p>
<p>The <code>crs</code> key is only used for <code>geoarrow.point</code> arrays; the <code>edges</code> key is only used for <code>geoarrow.linestring</code> and <code>geoarrow.polygon</code> arrays. Practically this was chosen so that child arrays can be passed to functions and validated independently (i.e., without having to pass the crs/edges values down the call stack as extra arguments). Conceptually this was chosen to keep metadata confined to the array for which it is relevant.</p>
<p>In geoarrow, you can view the decoded extension metadata using <code><a href="../reference/geoarrow_metadata.html">geoarrow_metadata()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/geoarrow_metadata.html">geoarrow_metadata</a></span><span class="op">(</span><span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_point</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="st">"OGC:CRS84"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; $crs</span>
<span class="co">#&gt; [1] "OGC:CRS84"</span>
<span class="fu"><a href="../reference/geoarrow_metadata.html">geoarrow_metadata</a></span><span class="op">(</span><span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_linestring</a></span><span class="op">(</span>edges <span class="op">=</span> <span class="st">"spherical"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; $edges</span>
<span class="co">#&gt; [1] "spherical"</span></code></pre></div>
<p>The serialized metadata looks like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_point</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="st">"OGC:CRS84"</span><span class="op">)</span><span class="op">$</span><span class="va">metadata</span>
<span class="co">#&gt; $`ARROW:extension:name`</span>
<span class="co">#&gt; [1] "geoarrow.point"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`ARROW:extension:metadata`</span>
<span class="co">#&gt;  [1] 01 00 00 00 03 00 00 00 63 72 73 09 00 00 00 4f 47 43 3a 43 52 53 38 34</span>
<span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_linestring</a></span><span class="op">(</span>edges <span class="op">=</span> <span class="st">"spherical"</span><span class="op">)</span><span class="op">$</span><span class="va">metadata</span>
<span class="co">#&gt; $`ARROW:extension:name`</span>
<span class="co">#&gt; [1] "geoarrow.linestring"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`ARROW:extension:metadata`</span>
<span class="co">#&gt;  [1] 01 00 00 00 05 00 00 00 65 64 67 65 73 09 00 00 00 73 70 68 65 72 69 63 61</span>
<span class="co">#&gt; [26] 6c</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="points">Points<a class="anchor" aria-label="anchor" href="#points"></a>
</h2>
<div class="section level3">
<h3 id="metadata-1">Metadata<a class="anchor" aria-label="anchor" href="#metadata-1"></a>
</h3>
<p>The field-level metadata for points in geoarrow must contain an extension type of “geoarrow.point” and extension metadata specifying an optional coordinate reference system.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">carray</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="st">"EPSG:4326"</span><span class="op">)</span>,
  schema <span class="op">=</span> <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_point</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">carray</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">metadata</span>
<span class="co">#&gt; $`ARROW:extension:name`</span>
<span class="co">#&gt; [1] "geoarrow.point"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`ARROW:extension:metadata`</span>
<span class="co">#&gt;  [1] 01 00 00 00 03 00 00 00 63 72 73 09 00 00 00 45 50 53 47 3a 34 33 32 36</span>
<span class="fu"><a href="../reference/geoarrow_metadata.html">geoarrow_metadata</a></span><span class="op">(</span><span class="va">carray</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span>
<span class="co">#&gt; $crs</span>
<span class="co">#&gt; [1] "EPSG:4326"</span></code></pre></div>
<p>The coordinate reference system in geoarrow is always stored with the point array, which is used as a child array for all other types.</p>
</div>
<div class="section level3">
<h3 id="storage-type">Storage type<a class="anchor" aria-label="anchor" href="#storage-type"></a>
</h3>
<p>Points are represented in geoarrow as a <a href="https://arrow.apache.org/docs/format/Columnar.html#fixed-size-list-layout" class="external-link">fixed-size list</a> of float64 (i.e., <code>double</code>) values. Conceptually this is much like storing coordinates as a (row-major) matrix with one row per feature and one column per dimension.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">carray</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"POINT (0 1)"</span>, <span class="st">"POINT (2 3)"</span><span class="op">)</span><span class="op">)</span>,
  schema <span class="op">=</span> <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_point</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu">narrow</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/narrow/reference/from_narrow_array.html" class="external-link">from_narrow_array</a></span><span class="op">(</span><span class="va">carray</span>, <span class="fu">arrow</span><span class="fu">::</span><span class="va"><a href="https://arrow.apache.org/docs/r/reference/array.html" class="external-link">Array</a></span><span class="op">)</span>
<span class="co">#&gt; ExtensionArray</span>
<span class="co">#&gt; &lt;geoarrow.point &lt;crs: unspecified&gt;&gt;</span>
<span class="co">#&gt; [</span>
<span class="co">#&gt;   [</span>
<span class="co">#&gt;     0,</span>
<span class="co">#&gt;     1</span>
<span class="co">#&gt;   ],</span>
<span class="co">#&gt;   [</span>
<span class="co">#&gt;     2,</span>
<span class="co">#&gt;     3</span>
<span class="co">#&gt;   ]</span>
<span class="co">#&gt; ]</span></code></pre></div>
<p>Points stored as a fixed-size list have exactly one child named <code>xy</code>, <code>xyz</code>, <code>xym</code>, or <code>xyzm</code>. The width of the fixed-size list must be 2, 3, or 4, and agree with the child name (e.g., if the child name is <code>xyzm</code>, it must be a fixed-size list of size 4). The child storage type must be a float64 for now (although in the future other child types like float32 or decimal128 may be supported).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># interleaved xy values in one buffer</span>
<span class="va">carray</span><span class="op">$</span><span class="va">array_data</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">buffers</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; &lt;pointer: 0x56200e50c690&gt;</span></code></pre></div>
<p>Other storage types of points that may be supported in a future reference implementation are:</p>
<ul>
<li>Struct-encoded points (i.e., x, y, and/or z and/or m stored in their own arrays)</li>
<li>Dictionary-encoded point representation (may allow for compact representation and efficient querying of polygon coverages with shared vertices)</li>
<li>S2 or H3 identifiers (compact and fast to test for containment)</li>
<li>float or decimal storage of coordinate values (float when lower precision is adequate; decimal when double precision is inadequate).</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="linestrings">Linestrings<a class="anchor" aria-label="anchor" href="#linestrings"></a>
</h2>
<div class="section level3">
<h3 id="metadata-2">Metadata<a class="anchor" aria-label="anchor" href="#metadata-2"></a>
</h3>
<p>The field-level metadata for linestrings in geoarrow must contain an extension type of “geoarrow.linestring” and extension metadata specifying an optional “edges” flag (see parent ‘Metadata’ section above).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">carray</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>geodesic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  schema <span class="op">=</span> <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_linestring</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">carray</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">metadata</span>
<span class="co">#&gt; $`ARROW:extension:name`</span>
<span class="co">#&gt; [1] "geoarrow.linestring"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`ARROW:extension:metadata`</span>
<span class="co">#&gt;  [1] 01 00 00 00 05 00 00 00 65 64 67 65 73 09 00 00 00 73 70 68 65 72 69 63 61</span>
<span class="co">#&gt; [26] 6c</span>
<span class="fu"><a href="../reference/geoarrow_metadata.html">geoarrow_metadata</a></span><span class="op">(</span><span class="va">carray</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span>
<span class="co">#&gt; $edges</span>
<span class="co">#&gt; [1] "spherical"</span></code></pre></div>
<p>The coordinate reference system in geoarrow is always stored with the point array (i.e., the child array of a geoarrow.linestring).</p>
</div>
<div class="section level3">
<h3 id="storage-type-1">Storage type<a class="anchor" aria-label="anchor" href="#storage-type-1"></a>
</h3>
<p>Linestrings are stored as a <code>list&lt;vertices: &lt;geoarrow.point&gt;&gt;</code>. The exact storage type of the geoarrow.point can vary as described above. Conceptually this is attaching buffer of (<code>int32_t</code>) offsets to an exiting array of points, where each offset points to the first vertex in a linestring.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">carray</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span><span class="st">"LINESTRING (1 2, 3 4)"</span><span class="op">)</span>,
  schema <span class="op">=</span> <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_linestring</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu">narrow</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/narrow/reference/from_narrow_array.html" class="external-link">from_narrow_array</a></span><span class="op">(</span><span class="va">carray</span>, <span class="fu">arrow</span><span class="fu">::</span><span class="va"><a href="https://arrow.apache.org/docs/r/reference/array.html" class="external-link">Array</a></span><span class="op">)</span>
<span class="co">#&gt; ExtensionArray</span>
<span class="co">#&gt; &lt;geoarrow.linestring &lt;crs: unspecified&gt;&gt;</span>
<span class="co">#&gt; [</span>
<span class="co">#&gt;   [</span>
<span class="co">#&gt;     [</span>
<span class="co">#&gt;       1,</span>
<span class="co">#&gt;       2</span>
<span class="co">#&gt;     ],</span>
<span class="co">#&gt;     [</span>
<span class="co">#&gt;       3,</span>
<span class="co">#&gt;       4</span>
<span class="co">#&gt;     ]</span>
<span class="co">#&gt;   ]</span>
<span class="co">#&gt; ]</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># offsets for each linestring into the vertices array</span>
<span class="va">carray</span><span class="op">$</span><span class="va">array_data</span><span class="op">$</span><span class="va">buffers</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; &lt;pointer: 0x56200dc4d920&gt;</span>

<span class="co"># coordinates</span>
<span class="va">carray</span><span class="op">$</span><span class="va">array_data</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">buffers</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; &lt;pointer: 0x56200b23b220&gt;</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="polygons">Polygons<a class="anchor" aria-label="anchor" href="#polygons"></a>
</h2>
<div class="section level3">
<h3 id="metadata-3">Metadata<a class="anchor" aria-label="anchor" href="#metadata-3"></a>
</h3>
<p>The field-level metadata for polygons in geoarrow must contain an extension type of “geoarrow.polygon” and extension metadata specifying an optional “edges” flag (see parent ‘Metadata’ section above).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">carray</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>geodesic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  schema <span class="op">=</span> <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_polygon</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">carray</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">metadata</span>
<span class="co">#&gt; $`ARROW:extension:name`</span>
<span class="co">#&gt; [1] "geoarrow.polygon"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`ARROW:extension:metadata`</span>
<span class="co">#&gt;  [1] 01 00 00 00 05 00 00 00 65 64 67 65 73 09 00 00 00 73 70 68 65 72 69 63 61</span>
<span class="co">#&gt; [26] 6c</span>
<span class="fu"><a href="../reference/geoarrow_metadata.html">geoarrow_metadata</a></span><span class="op">(</span><span class="va">carray</span><span class="op">$</span><span class="va">schema</span><span class="op">)</span>
<span class="co">#&gt; $edges</span>
<span class="co">#&gt; [1] "spherical"</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="storage-type-2">Storage type<a class="anchor" aria-label="anchor" href="#storage-type-2"></a>
</h3>
<p>Linestrings are stored as a <code>list&lt;rings: &lt;list&lt;vertices: &lt;geoarrow.point&gt;&gt;&gt;</code>. The exact storage type of the geoarrow.point can vary as described above. Conceptually this is attaching buffer of (<code>int32_t</code>) offsets to an exiting array of points, where each offset points to the first vertex in a linear ring. The outer list then contains offsets to the start of each polygon in the rings array. Just like WKB, rings must be closed (i.e., the first coordinate must equal the last coordinate).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">carray</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span><span class="st">"POLYGON ((0 0, 1 0, 0 1, 0 0))"</span><span class="op">)</span>,
  schema <span class="op">=</span> <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_polygon</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu">narrow</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/narrow/reference/from_narrow_array.html" class="external-link">from_narrow_array</a></span><span class="op">(</span><span class="va">carray</span>, <span class="fu">arrow</span><span class="fu">::</span><span class="va"><a href="https://arrow.apache.org/docs/r/reference/array.html" class="external-link">Array</a></span><span class="op">)</span>
<span class="co">#&gt; ExtensionArray</span>
<span class="co">#&gt; &lt;geoarrow.polygon &lt;crs: unspecified&gt;&gt;</span>
<span class="co">#&gt; [</span>
<span class="co">#&gt;   [</span>
<span class="co">#&gt;     [</span>
<span class="co">#&gt;       [</span>
<span class="co">#&gt;         0,</span>
<span class="co">#&gt;         0</span>
<span class="co">#&gt;       ],</span>
<span class="co">#&gt;       [</span>
<span class="co">#&gt;         1,</span>
<span class="co">#&gt;         0</span>
<span class="co">#&gt;       ],</span>
<span class="co">#&gt;       [</span>
<span class="co">#&gt;         0,</span>
<span class="co">#&gt;         1</span>
<span class="co">#&gt;       ],</span>
<span class="co">#&gt;       [</span>
<span class="co">#&gt;         0,</span>
<span class="co">#&gt;         0</span>
<span class="co">#&gt;       ]</span>
<span class="co">#&gt;     ]</span>
<span class="co">#&gt;   ]</span>
<span class="co">#&gt; ]</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># offsets for each polygon into the ring array</span>
<span class="va">carray</span><span class="op">$</span><span class="va">array_data</span><span class="op">$</span><span class="va">buffers</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; &lt;pointer: 0x56200b5dbc00&gt;</span>

<span class="co"># offsets for each ring into the vertices array</span>
<span class="va">carray</span><span class="op">$</span><span class="va">array_data</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">buffers</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; &lt;pointer: 0x562007f8f3a0&gt;</span>

<span class="co"># coordinates</span>
<span class="va">carray</span><span class="op">$</span><span class="va">array_data</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">buffers</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; &lt;pointer: 0x56200de9f040&gt;</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="collections">Collections<a class="anchor" aria-label="anchor" href="#collections"></a>
</h2>
<div class="section level3">
<h3 id="metadata-4">Metadata<a class="anchor" aria-label="anchor" href="#metadata-4"></a>
</h3>
<p>Just like WKB, multipoints, multilinestrings, multipolygons, and geometrycollections share a common encoding but have different identifiers.</p>
<ul>
<li>Multipoint geometries have an <code>ARROW:extension:name</code> of “geoarrow.multipoint” and must contain a child named “points” with the “geoarrow.point” extension type.</li>
<li>Multilinestring geometries have an <code>ARROW:extension:name</code> of “geoarrow.multilinestring” and must contain a child named “linestrings” with the “geoarrow.linestring” extension type.</li>
<li>Multipolygon geometries have an <code>ARROW:extension:name</code> of “geoarrow.multipolygon” and must contain a child named “polygons” with the “geoarrow.polygon” extension type.</li>
<li>Geometry collections (i.e., mixed arrays of points, lines, polygons, multipoints, multipolygons, and/or geometry collections) are not currently supported. For those who need to communicate these objects, use the “geoarrow.wkb” extension type. In the future, support for these will be added as unions (i.e., the child array will be a sparse or dense union of points, lines, polygons, multipoints, multilinestrings, and/or multipolygons).</li>
</ul>
<p>Collections do not carry extension metadata of their own (i.e., the CRS and edges flags stay with the array for which they are relevant). The metadata string should not be omitted and must be empty (i.e., 0 as a 32-bit integer).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">carray</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span>geodesic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  schema <span class="op">=</span> <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_multipoint</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">carray</span><span class="op">$</span><span class="va">schema</span><span class="op">$</span><span class="va">metadata</span>
<span class="co">#&gt; $`ARROW:extension:name`</span>
<span class="co">#&gt; [1] "geoarrow.multipoint"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $`ARROW:extension:metadata`</span>
<span class="co">#&gt; [1] 00 00 00 00</span></code></pre></div>
<p>(TODO: I didn’t actually implement the different extension names for different types of collections yet!!)</p>
</div>
<div class="section level3">
<h3 id="storage-type-3">Storage type<a class="anchor" aria-label="anchor" href="#storage-type-3"></a>
</h3>
<ul>
<li>Multipoints are stored as a <code>list&lt;points: &lt;geoarrow.point&gt;&gt;</code>
</li>
<li>Multilinestrings are stored as a <code>list&lt;linestrings: &lt;geoarrow.linestring&gt;&gt;</code>
</li>
<li>Multipolygons are stored as a <code>list&lt;polygons: &lt;geoarrow.polygon&gt;&gt;</code>
</li>
</ul>
<p>Conceptually this is attaching a buffer of (<code>int32_t</code>) offsets to an existing array of points, lines, or polygons.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">carray</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geoarrow_create_narrow.html">geoarrow_create_narrow</a></span><span class="op">(</span>
  <span class="fu">wk</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/wk/reference/wkt.html" class="external-link">wkt</a></span><span class="op">(</span><span class="st">"MULTIPOINT (1 2, 3 4)"</span><span class="op">)</span>,
  schema <span class="op">=</span> <span class="fu"><a href="../reference/geoarrow_schema_point.html">geoarrow_schema_multipoint</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu">narrow</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/narrow/reference/from_narrow_array.html" class="external-link">from_narrow_array</a></span><span class="op">(</span><span class="va">carray</span>, <span class="fu">arrow</span><span class="fu">::</span><span class="va"><a href="https://arrow.apache.org/docs/r/reference/array.html" class="external-link">Array</a></span><span class="op">)</span>
<span class="co">#&gt; ExtensionArray</span>
<span class="co">#&gt; &lt;geoarrow.multipoint &lt;crs: unspecified&gt;&gt;</span>
<span class="co">#&gt; [</span>
<span class="co">#&gt;   [</span>
<span class="co">#&gt;     [</span>
<span class="co">#&gt;       1,</span>
<span class="co">#&gt;       2</span>
<span class="co">#&gt;     ],</span>
<span class="co">#&gt;     [</span>
<span class="co">#&gt;       3,</span>
<span class="co">#&gt;       4</span>
<span class="co">#&gt;     ]</span>
<span class="co">#&gt;   ]</span>
<span class="co">#&gt; ]</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># offsets for each multipoint into the points array</span>
<span class="va">carray</span><span class="op">$</span><span class="va">array_data</span><span class="op">$</span><span class="va">buffers</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; &lt;pointer: 0x56200dc4d940&gt;</span>

<span class="co"># coordinates</span>
<span class="va">carray</span><span class="op">$</span><span class="va">array_data</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">children</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">buffers</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#&gt; &lt;pointer: 0x56200dba45b0&gt;</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="relationship-to-well-known-binary">Relationship to well-known binary<a class="anchor" aria-label="anchor" href="#relationship-to-well-known-binary"></a>
</h2>
<p>The physical layout and logical types specified in this document are designed to align with well-known binary (WKB), as this is currently the most popular binary encoding used to store and shuffle geometries between libraries. For example, a linestring in WKB is encoded as:</p>
<ul>
<li>One byte describing endian (<code>0x01</code> or <code>0x00</code>)</li>
<li>A <code>uint32_t</code> describing the geometry type and its dimensions. For a linestring this will be 2 (for XY), 1002 (for XYZ), 2002 (for XYM), or 3002 (for XYZM).</li>
<li>A <code>uint32_t</code> of how many vertices are contained in the linestring</li>
<li>An buffer of <code>double</code> containing coordinates with coordinate values kept together. For example, the points (1 2, 3 4, 5 6) would be encoded as [1, 2, 3, 4, 5, 6].</li>
</ul>
<p>In this specification, we store the same information as WKB but organized differently:</p>
<ul>
<li>A <a href="https://arrow.apache.org/docs/format/CDataInterface.html#the-arrowschema-structure" class="external-link"><code>struct ArrowSchema</code></a> that contains the storage type and metadata. The default representation of a linestring is stored as a <code>list_of&lt;vertices: fixed_list_of&lt;xy: float64, 2&gt;&gt;</code>, where the child name of the fixed list stores the dimensions (xy) of the coordinates.</li>
<li>A <a href="https://arrow.apache.org/docs/format/CDataInterface.html#the-arrowarray-structure" class="external-link"><code>struct ArrowArray()</code></a> that contains the coordinate values and lengths of each linestring. For example, a linestring containing the points (1 2, 3 4, 5 6) is encoded by default using:
<ul>
<li>An <code>int32_t</code> buffer of offsets to the start/end of each linestring in the points array. Because our example only includes one linestring, this would be two numbers [0, 3]. The length of each linestring can be calculated by subtracting (i.e., <code>offset_array[i + 1] - offset_array[i]</code>).</li>
<li>A <code>double</code> buffer containing coordinates with coordinate values kept together (i.e., [1, 2, 3, 4, 5, 6]).</li>
</ul>
</li>
</ul>
<p>You can learn more about these buffers and the C structures that geoarrow uses to represent them in memory in the <a href="https://arrow.apache.org/docs/format/Columnar.html" class="external-link">Arrow Columnar Format specification</a> and the <a href="https://arrow.apache.org/docs/format/CDataInterface.html" class="external-link">C Data interface specification</a>. For a detailed guide to iterating over geometries in C and C++, see the <a href="development.html">C and C++ development guide</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Dewey Dunnington.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>

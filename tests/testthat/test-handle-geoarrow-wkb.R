
test_that("geoarrow.wkb works and missing values", {
  point <- as.raw(c(0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
                    0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                    0x00, 0x24, 0x40))
  arr_wkb <- geoarrow_create(
    wk::new_wk_wkb(list(point, NULL)),
    schema = geoarrow_schema_wkb()
  )

  expect_identical(wk::as_wkt(arr_wkb), wk::wkt(c("POINT (30 10)", NA)))
})

test_that("geoarrow.wkb works with multiple endians", {

  point_be <- as.raw(c(0x00, 0x00, 0x00, 0x00, 0x01, 0x40, 0x3e,
                       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x24, 0x00, 0x00, 0x00,
                       0x00, 0x00, 0x00))

  point_le <- as.raw(c(0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
                       0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                       0x00, 0x24, 0x40))

  arr_wkb <- geoarrow_create(
    wk::new_wk_wkb(list(point_be, point_le)),
    schema = geoarrow_schema_wkb()
  )

  expect_identical(wk::as_wkt(arr_wkb), wk::wkt(c("POINT (30 10)", "POINT (30 10)")))
})

test_that("geoarrow.wkb works with ND points and SRID", {

  point_xy <- as.raw(c(0x01, #
                       0x01, 0x00, 0x00, 0x00, # type
                       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, # x
                       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40)) # y

  point_z <- as.raw(c(0x01,
                      0x01, 0x00, 0x00, 0x80, # type
                      0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x3e, 0x40, # x
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40, # y
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40)) # z

  point_m <- as.raw(c(0x01,
                      0x01, 0x00, 0x00, 0x40, # type
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, # x
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40, # y
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40)) # m

  point_zm <- as.raw(c(0x01,
                       0x01, 0x00, 0x00, 0xc0, # type
                       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, # x
                       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40, # y
                       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, # z
                       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x3f)) # m

  point_s <- as.raw(c(0x01,
                      0x01, 0x00, 0x00, 0x20, # type
                      0xc7, 0x00, 0x00, 0x00, # srid
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, # x
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40)) # y

  point_zms <- as.raw(c(0x01,
                        0x01, 0x00, 0x00, 0xe0,
                        0xe6, 0x10, 0x00, 0x00,
                        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40,
                        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40,
                        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x40,
                        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2c, 0x40))

  arr_wkb <- geoarrow_create(
    wk::new_wk_wkb(
      list(
        point_xy, point_z, point_m, point_zm,
        point_s, point_zms
      )
    ),
    schema = geoarrow_schema_wkb()
  )

  expect_identical(
    wk::as_wkt(arr_wkb),
    wk::wkt(
      c(
        "POINT (30 10)", "POINT Z (30 10 2)", "POINT M (30 10 2)",
        "POINT ZM (30 10 2 1)", "SRID=199;POINT (30 10)",
        "SRID=4326;POINT ZM (30 10 12 14)"
      )
    )
  )
})

test_that("geoarrow.wkb works simple geometries", {

  # POINT (30 10)
  point <- as.raw(c(0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
                    0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                    0x00, 0x24, 0x40))

  # LINESTRING (30 10, 12 42)
  linestring <- as.raw(c(0x01, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00,
                         0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, 0x00,
                         0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x00, 0x28, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x45,
                         0x40))

  # POLYGON ((35 10, 45 45, 15 40, 10 20, 35 10), (20 30, 35 35, 30 20, 20 30))
  polygon <- as.raw(c(0x01, 0x03, 0x00, 0x00, 0x00, 0x02, 0x00,
                      0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                      0x80, 0x41, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40,
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x46, 0x40, 0x00, 0x00, 0x00,
                      0x00, 0x00, 0x80, 0x46, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                      0x2e, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x40, 0x00,
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00,
                      0x00, 0x00, 0x34, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x41,
                      0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40, 0x04, 0x00,
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00,
                      0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, 0x00, 0x00, 0x00, 0x00,
                      0x00, 0x80, 0x41, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x41,
                      0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, 0x00, 0x00,
                      0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                      0x00, 0x34, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40))

  arr_wkb <- geoarrow_create(
    wk::new_wk_wkb(list(point, linestring, polygon)),
    schema = geoarrow_schema_wkb()
  )

  expect_identical(
    wk::as_wkt(arr_wkb),
    wk::wkt(
      c(
        "POINT (30 10)",
        "LINESTRING (30 10, 12 42)",
        "POLYGON ((35 10, 45 45, 15 40, 10 20, 35 10), (20 30, 35 35, 30 20, 20 30))"
      )
    )
  )
})

test_that("geoarrow.wkb works with multi geometries", {
  # MULTIPOINT ((10 40), (40 30), (20 20), (30 10))
  multipoint <- as.raw(c(0x01, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00,
                         0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44,
                         0x40, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x44, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40,
                         0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x34, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x01,
                         0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e,
                         0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40))

  arr_wkb <- geoarrow_create(
    wk::new_wk_wkb(list(multipoint)),
    schema = geoarrow_schema_wkb()
  )

  expect_identical(
    wk::as_wkt(arr_wkb),
    wk::wkt(
      c(
        "MULTIPOINT ((10 40), (40 30), (20 20), (30 10))"
      )
    )
  )
})

test_that("geoarrow.wkb works with nested collections", {
  wkt <-
    "GEOMETRYCOLLECTION (POINT (40 10),
    LINESTRING (10 10, 20 20, 10 40),
    POLYGON ((40 40, 20 45, 45 30, 40 40)),
    GEOMETRYCOLLECTION (POINT (40 10),
      LINESTRING (10 10, 20 20, 10 40),
      POLYGON ((40 40, 20 45, 45 30, 40 40))),
    GEOMETRYCOLLECTION EMPTY,
    POINT (30 10))"

  collection <- as.raw(c(0x01, 0x07, 0x00, 0x00, 0x00, 0x06, 0x00,
                         0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x00, 0x44, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24,
                         0x40, 0x01, 0x02, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34,
                         0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00,
                         0x00, 0x00, 0x00, 0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x44, 0x40, 0x01, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
                         0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x44, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x40, 0x00,
                         0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x80, 0x46, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x46,
                         0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, 0x00, 0x00,
                         0x00, 0x00, 0x00, 0x00, 0x44, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x44, 0x40, 0x01, 0x07, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00,
                         0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x44, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40,
                         0x01, 0x02, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x00, 0x00, 0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40,
                         0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00, 0x00,
                         0x00, 0x00, 0x00, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x44, 0x40, 0x01, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
                         0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44,
                         0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x40, 0x00, 0x00,
                         0x00, 0x00, 0x00, 0x00, 0x34, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x80, 0x46, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x46, 0x40,
                         0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x40, 0x00, 0x00, 0x00,
                         0x00, 0x00, 0x00, 0x44, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x44, 0x40, 0x01, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                         0x3e, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40))

  arr_wkb <- geoarrow_create(
    wk::new_wk_wkb(list(collection)),
    schema = geoarrow_schema_wkb()
  )

  expect_identical(
    wk::as_wkt(arr_wkb),
    wk::wkt(gsub("\\s+", " ", wkt))
  )
})

test_that("wkb reader can read 1000-3000 style WKB input", {
  wkb_xyz <- as.raw(c(0x01, 0xe9, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                      0x00, 0x00, 0xf0, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                      0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x40))

  wkb_xym <- as.raw(c(0x01, 0xd1, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                      0x00, 0x00, 0xf0, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                      0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x40))

  wkb_xyzm <- as.raw(c(0x01, 0xb9, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                       0x00, 0x00, 0xf0, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                       0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x40, 0x00, 0x00,
                       0x00, 0x00, 0x00, 0x00, 0x10, 0x40))

  arr_wkb <- geoarrow_create(
    wk::new_wk_wkb(list(wkb_xyz, wkb_xym, wkb_xyzm)),
    schema = geoarrow_schema_wkb()
  )

  expect_identical(
    wk::as_wkt(arr_wkb),
    wk::wkt(c("POINT Z (1 2 3)", "POINT M (1 2 3)", "POINT ZM (1 2 3 4)"))
  )
})
